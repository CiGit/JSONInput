"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t=require("react"),r=e(require("immer")),n=require("jsonschema"),a=require("lodash-es");function o(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function i(){return(i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function s(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function u(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?s(r,!0).forEach(function(t){o(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):s(r).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function c(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t}function p(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}var l=t.createContext({value:void 0,schema:{},status:{}}),h=l.Consumer,f=function(e){function n(){for(var t,n=arguments.length,a=new Array(n),i=0;i<n;i++)a[i]=arguments[i];return o(p(t=e.call.apply(e,[this].concat(a))||this),"state",{schema:{},value:{},extValue:{},status:{},oldProps:{}}),o(p(t),"dispatch",function(e){for(var n=arguments.length,a=new Array(n>1?n-1:0),o=1;o<n;o++)a[o-1]=arguments[o];t.setState(function(t){return r(e).apply(void 0,[t].concat(a))})}),t}c(n,e),n.getDerivedStateFromProps=function(e,t){if(t.oldProps!==e){var r={value:e.value,schema:e.schema,oldProps:e};return e.value!==t.extValue&&(r.status={},r.extValue=e.value),r}return null};var a=n.prototype;return a.shouldComponentUpdate=function(e,t){return this.state!==t},a.componentDidUpdate=function(e,t){var r=this;if(this.state.value!==t.value&&this.props.value===e.value){var n=this.state.value;this.setState({extValue:n},function(){return r.props.onValueChange(n)})}},a.render=function(){var e=this.state,r=e.schema,n=e.value,a=e.status,o=null!=n?JSON.parse(JSON.stringify(n)):n;return t.createElement(l.Provider,{value:{schema:r,value:o,status:a}},this.props.children({schema:r,value:o,status:a,dispatch:this.dispatch}))},n}(t.Component);function v(e){return function(){return t.createElement("span",null,"Widget for '"+e+"' was not defined")}}var d={};function y(e){return d[e]||v(e)}function m(e){d=Object.assign({},d,e)}var g={};function b(e){var r=e.value,n=e.schema,a=e.schema.view,o=e.__tree.value,s={value:r,schema:n,children:e.children,editKey:e.editKey,path:e.path,onChange:e.onChange,onChildAdd:e.onChildAdd,onChildRemove:e.onChildRemove,addKey:e.addKey,removeKey:e.removeKey,alterKey:e.alterKey,errorMessage:e.errorMessage};if(a){var u=a.type;if("string"==typeof u){var c=y(u);return t.createElement(c,i({},s,{formValue:o,view:a}))}if("function"==typeof u){var p=u;return t.createElement(p,i({},s,{formValue:o,view:a}))}}var l,h=Array.isArray(n.type)?n.type.find(function(e){return"null"!==e}):n.type;return l=y(void 0===h?"undefinedType":h),t.createElement(l,i({},s,{formValue:o,view:a||g}))}var C=new n.Validator;function E(e,t,r,n){return C.validate(e,t,{formValue:r||{},ctx:{basePath:n}})}C.attributes.errored=function(e,t,r,a){if("function"!=typeof t.errored)throw new n.SchemaError('"errored" expects a function');var o=(r.ctx.basePath||[]).concat(a.propertyPath.split(".").slice(1)),i=t.errored(e,r.formValue,o);if(i)return i};var w="value",O="status",j="$$$state",P="$$$errors",K=[];function A(e,t,r){void 0===t&&(t=[]);var n=[O].concat(t).concat([P]);a.setWith(e,n,r,Object)}function k(e,t,r){void 0===t&&(t=[]);var n=new Map;r.forEach(function(e){var t=n.get(e.property)||[];t.push(e.message),n.set(e.property,t)}),A(e,t,K),n.forEach(function(r,n){A(e,t.concat(n.split(/\.|\[|\]/).filter(function(e){return""!==e}).slice(1)),r)})}function S(e,t,r,n){void 0===t&&(t=[]);var o=[O].concat(t);a.setWith(e,[w].concat(t),r,Object),a.setWith(e,o.concat([j]),"dirty",Object),k(e,t,n)}function _(e,t,r){void 0===t&&(t=[]),S(e,t,r,[]),a.setWith(e,[O].concat(t).concat([j]),"pristine",Object)}function x(e,t){void 0===t&&(t=[]);try{a.unset(e,[O].concat(t))}catch(e){}}function V(e,t){return void 0===t&&(t=[]),a.get(e,[O].concat(t).concat([P]))||K}function D(e){var r=function(r){function n(){for(var e,t=arguments.length,n=new Array(t),a=0;a<t;a++)n[a]=arguments[a];return o(p(e=r.call.apply(r,[this].concat(n))||this),"onChange",function(t){var r=E(t,e.props.schema,e.props.__tree.value,e.props.path);e.props.onChange(t,r.errors)}),e}c(n,r);var a=n.prototype;return a.shouldComponentUpdate=function(e){return this.props.value!==e.value||this.props.schema!==e.schema||V(this.props.__tree,this.props.path)!==V(e.__tree,e.path)},a.render=function(){var r=this.props.path;return t.createElement(e,i({},this.props,{errorMessage:V(this.props.__tree,r),onChange:this.onChange}))},n}(t.Component);return function(e){return t.createElement(h,null,function(n){return t.createElement(r,i({},e,{__tree:n}))})}}function N(e,t){var r=e.properties,n=void 0===r?{}:r;if(t in n)return n[t]}function M(e,t){var r=e.patternProperties||{},n=Object.keys(r).find(function(e){return new RegExp(e).test(t)});if(n)return r[n]}function W(e,t){return N(e,t)||M(e,t)||e.additionalProperties}var $={},q=function(e){function r(){for(var t,r=arguments.length,n=new Array(r),a=0;a<r;a++)n[a]=arguments[a];return o(p(t=e.call.apply(e,[this].concat(n))||this),"keys",new Map),o(p(t),"keyId",0),o(p(t),"addKey",function(e,r){var n;if("object"==typeof t.props.value&&e in t.props.value)throw new Error('Property "'+e+'" already exists');t.keys.set(e,String(t.keyId++)),t.props.onChange(Object.assign({},t.props.value,((n={})[e]=r,n)))}),o(p(t),"removeKey",function(e){var r=Object.assign({},t.props.value);delete r[e],t.keys.delete(e),t.props.onChange(r)}),o(p(t),"alterKey",function(e,r){if(e!==r){if(r in t.props.value)throw new Error('Property "'+r+'" already exists');var n={};Object.keys(t.props.value).forEach(function(a){a!==e?n[a]=t.props.value[a]:n[r]=t.props.value[a]});var a=t.keys.get(e);t.keys.delete(e),t.keys.set(r,a),t.props.onChange(n)}}),t}c(r,e);var n=r.prototype;return n.renderChildren=function(e){var r=[],n=e.schema.properties||{},a=e.value||{},o=Object.keys(n);function s(e){if(n[e]){var t=n[e].index;if("number"==typeof t)return t}return 0}Object.keys(a).forEach(function(e){e in n||o.push(e)}),o.sort(function(e,t){return s(e)-s(t)});for(var u=new Map,c=0;c<o.length;c+=1){var p=o[c],l=W(e.schema,p);this.keys.has(p)?u.set(p,this.keys.get(p)):u.set(p,String(this.keyId++)),r.push(t.createElement(ue,i({},e,{status:e.status[p]||$,schema:l,value:a[p],editKey:p,key:u.get(p)})))}return this.keys=u,r},n.render=function(){return t.createElement(b,i({},this.props,{addKey:this.addKey,removeKey:this.removeKey,alterKey:this.alterKey}),this.renderChildren(this.props))},r}(t.Component),R=D(q);function U(e){return t.createElement(b,e)}var F=D(U);function I(e){switch(typeof e){case"number":return e;case"string":return""===e?void 0:Number(e);default:return}}var J=function(e){function r(){for(var t,r=arguments.length,n=new Array(r),a=0;a<r;a++)n[a]=arguments[a];return o(p(t=e.call.apply(e,[this].concat(n))||this),"state",{value:t.props.value}),o(p(t),"onChange",function(e){var r=""===e?void 0:e,n=Number(r);t.setState({value:r},function(){return t.props.onChange(isNaN(n)?r:n)})}),t}return c(r,e),r.prototype.render=function(){return t.createElement(U,i({},this.props,{value:this.state.value,onChange:this.onChange}))},r}(t.Component);o(J,"getDerivedStateFromProps",function(e,t){return I(t.value)!==I(e.value)?{value:e.value}:null});var T=D(J);function z(e){return t.createElement(b,e)}var B=D(z),G={};function H(e){return function(t){var r=e.value||[];e.onChange(r.filter(function(e,r){return Number(r)!==Number(t)}))}}function L(e){return function(t){var r=e.value||[];e.onChange(r.concat([t]))}}function Q(e){var r=e.value,n=e.schema.items,a=[];return(r||[]).forEach(function(r,o){return a.push(t.createElement(ue,i({},e,{schema:Array.isArray(n)?n[o]||{}:n,value:r,editKey:String(o),status:e.status[String(o)]||G,key:o})))}),a}function X(e){return t.createElement(b,i({},e,{onChildAdd:L(e),onChildRemove:H(e)}),Q(e))}var Y=D(X),Z={object:R,string:F,number:T,boolean:B,array:Y};function ee(e){return function(r){var n=r.schema.visible,a=r.value;return t.createElement(h,null,function(o){var i=o.value;try{if(n&&!n(a,i,r.path.concat()))return null}catch(e){return null}return t.createElement(e,r)})}}function te(e){return t.createElement("div",null,'Undefined field type "'+e.schema.type.toString()+'", ['+e.path.toString()+"]")}function re(e){switch(typeof e){case"number":return"number";case"string":return"string";case"boolean":return"boolean";case"object":return Array.isArray(e)?"array":"object";default:return"string"}}function ne(e,t){return void 0!==t?e.concat([t]):e}function ae(e){return function(r){function n(){for(var e,t=arguments.length,n=new Array(t),a=0;a<t;a++)n[a]=arguments[a];return o(p(e=r.call.apply(r,[this].concat(n))||this),"state",{path:[],schema:{}}),e}return c(n,r),n.getDerivedStateFromProps=function(e,t){var r={};if(t.oldEditKey===e.editKey&&t.oldPath===e.path||(r.path=ne(e.path,e.editKey),r.oldPath=e.path,r.oldEditKey=e.editKey),t.schema!==e.schema||re(e.value)!==re(t.oldValue)){var n=e.schema||{};"type"in n||(n=u({type:re(e.value)},n)),r.schema=n}return r},n.prototype.render=function(){var r=this.state.schema.type;return t.createElement(e,i({key:Array.isArray(r)?void 0:r},this.props,{path:this.state.path,schema:this.state.schema}))},n}(t.Component)}function oe(e){var t=e.value,r=e.schema.value,n=e.dispatch,o=e.path,i=void 0!==t?t:a.cloneDeep(r);return i!==t&&n(_,o,i),i}function ie(e){return function(r){function n(){for(var e,t=arguments.length,n=new Array(t),a=0;a<t;a++)n[a]=arguments[a];return o(p(e=r.call.apply(r,[this].concat(n))||this),"state",{val:oe(e.props),init:!0}),e}return c(n,r),n.getDerivedStateFromProps=function(e,t){var r=e.schema,n=e.value,o=e.dispatch,i=e.path;if("const"in r&&!a.isEqual(r.const,n)){var s=a.cloneDeep(r.const);return o(_,i,s),{val:s}}return t.init?{init:!1}:{val:e.value}},n.prototype.render=function(){return t.createElement(e,i({},this.props,{value:this.state.val}))},n}(t.Component)}var se=function(e){function r(t){var r;return(r=e.call(this,t)||this).onChange=r.onChange.bind(p(r)),r}c(r,e);var n=r.prototype;return n.onChange=function(){for(var e,t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n];(e=this.props).dispatch.apply(e,[S,this.props.path].concat(r))},n.componentWillUnmount=function(){this.props.dispatch(x,this.props.path)},n.render=function(){var e,r=this.props.schema.type,n=Array.isArray(r)?r.find(function(e){return"null"!==e}):r;return void 0===(e=void 0===n||"null"===n?te:Z[n])&&(e=te),t.createElement(e,i({},this.props,{onChange:this.onChange}))},r}(t.Component);o(se,"defaultProps",{path:[]});var ue=ae(ie(ee(se))),ce=[],pe=function(e){function r(){for(var t,r=arguments.length,n=new Array(r),a=0;a<r;a++)n[a]=arguments[a];return o(p(t=e.call.apply(e,[this].concat(n))||this),"store",null),o(p(t),"update",function(e){t.props.onChange(e,E(e,t.props.schema,e).errors)}),t}c(r,e);var n=r.prototype;return n.getValue=function(){return this.store.state.value},n.validate=function(){var e=E(this.store.state.value,this.store.state.schema,this.store.state.value);return this.store.dispatch(k,[],e.errors),e.errors},n.render=function(){var e=this;return t.createElement(f,{ref:function(t){e.store=t},value:this.props.value,schema:this.props.schema,onValueChange:this.update},function(e){var r=e.schema,n=e.value,a=e.status,o=e.dispatch;return t.createElement(ue,{schema:r,dispatch:o,value:n,path:ce,status:a})})},r}(t.Component);o(pe,"defaultProps",{schema:{}}),exports.default=pe,exports.setDefaultWidgets=m;
//# sourceMappingURL=index.js.map
