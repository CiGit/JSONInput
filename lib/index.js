'use strict';Object.defineProperty(exports,'__esModule',{value:!0});function _interopDefault(a){return a&&'object'==typeof a&&'default'in a?a['default']:a}var React=require('react'),higherOrder=require('baobab-react/higher-order'),Baobab=_interopDefault(require('baobab')),jsonschema=require('jsonschema'),createTree=function(){return new Baobab({schema:{},value:{},status:{}})};function undefinedWidgetFactory(b){return function(){return React.createElement('span',null,'Widget for \''+b+'\' was not defined')}}var DefaultWidget={};function defaultWidget(b){return DefaultWidget[b]||undefinedWidgetFactory(b)}function setDefaultWidgets(b){DefaultWidget=Object.assign({},DefaultWidget,b)}var _typeof='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&'function'==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?'symbol':typeof a},asyncGenerator=function(){function a(a){this.value=a}function b(b){function c(e,f){try{var g=b[e](f),h=g.value;h instanceof a?Promise.resolve(h.value).then(function(a){c('next',a)},function(a){c('throw',a)}):d(g.done?'return':'normal',g.value)}catch(a){d('throw',a)}}function d(a,b){'return'===a?e.resolve({value:b,done:!0}):'throw'===a?e.reject(b):e.resolve({value:b,done:!1});e=e.next,e?c(e.key,e.arg):f=null}var e,f;this._invoke=function(a,b){return new Promise(function(d,g){var h={key:a,arg:b,resolve:d,reject:g,next:null};f?f=f.next=h:(e=f=h,c(a,b))})},'function'!=typeof b.return&&(this.return=void 0)}return'function'==typeof Symbol&&Symbol.asyncIterator&&(b.prototype[Symbol.asyncIterator]=function(){return this}),b.prototype.next=function(a){return this._invoke('next',a)},b.prototype.throw=function(a){return this._invoke('throw',a)},b.prototype.return=function(a){return this._invoke('return',a)},{wrap:function(a){return function(){return new b(a.apply(this,arguments))}},await:function(b){return new a(b)}}}(),classCallCheck=function(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')},_extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a},inherits=function(a,b){if('function'!=typeof b&&null!==b)throw new TypeError('Super expression must either be null or a function, not '+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)},possibleConstructorReturn=function(a,b){if(!a)throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called');return b&&('object'==typeof b||'function'==typeof b)?b:a},EMPTYOBJECT={};function Widget(t){var a=t.value,u=t.schema,v=t.schema.view,w=t.children,x=t.editKey,y=t.path,z=t.onChange,A=t.onChildAdd,B=t.onChildRemove,C=t.addKey,D=t.removeKey,E=t.alterKey,F=t.errorMessage,G={value:a,schema:u,children:w,editKey:x,path:y,onChange:z,onChildAdd:A,onChildRemove:B,addKey:C,removeKey:D,alterKey:E,errorMessage:F};if(v){var o=v.type;if('string'==typeof o){var H=defaultWidget(o);return React.createElement(H,_extends({},G,{view:v}))}if('function'==typeof o)return React.createElement(o,_extends({},G,{view:v}))}var s,q=Array.isArray(u.type)?u.type.find(function(b){return'null'!==b}):u.type;return s=void 0===q?defaultWidget('undefinedType'):defaultWidget(q),React.createElement(s,_extends({},G,{view:v||EMPTYOBJECT}))}var customValidator=new jsonschema.Validator;customValidator.attributes.errored=function(e,a,b){if('function'!=typeof a.errored)throw new jsonschema.SchemaError('"errored" expects a function');var c=a.errored(e,b.formValue);return c?c:void 0};function validate(d,a,b){return customValidator.validate(d,a,{formValue:b})}var VALUE='value',STATUS='status',STATE='state',ERRORS='errors',NO_ERRORS=[];function setErrors(f){var a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],b=arguments[2],c=[STATUS].concat(a).concat([ERRORS]),d=f.select(c);b&&b.length&&Array.isArray(d.get())?(d.splice([0,d.get().length]),d.concat(b||[])):d.set(b||NO_ERRORS)}function update(f){var a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],b=arguments[2],c=arguments[3],d=[STATUS].concat(a);f.set([VALUE].concat(a),b),f.set(d.concat([STATE]),'dirty'),setErrors(f,a,c)}function setDefaultValue(d){var a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],b=arguments[2];d.set([VALUE].concat(a),b),d.set([STATUS].concat(a).concat([STATE]),'pristine')}function getErrors(c){var a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[];return c.get([STATUS].concat(a).concat([ERRORS]))||NO_ERRORS}function getFormValue(b){return b.get(VALUE)}function validated(c){return function(e){return React.createElement(c,_extends({},e,{errorMessage:e.dispatch(getErrors,e.path),onChange:function(b){var a=validate(b,e.schema,e.dispatch(getFormValue)),c=a.errors.map(function(b){return b.message});e.onChange(b,c)}}))}}var EMPTY_OBJECT={};function renderChildren(i){function k(d){if(c[d]){var a=c[d].index;if('number'==typeof a)return a}return 0}var a=[],c=i.schema.properties||{},b=i.value||{},d=Object.keys(c);Object.keys(b).forEach(function(b){b in c||d.push(b)}),d.sort(function(b,c){return k(b)-k(c)});for(var e,f=0;f<d.length;f+=1)if(e=d[f],e in c)a.push(React.createElement(SchemaType$1,_extends({},i,{status:i.status[e]||EMPTY_OBJECT,schema:c[e],value:b[e],editKey:e,key:f})));else{var l=i.schema.additionalProperties;a.push(React.createElement(SchemaType$1,_extends({},i,{status:i.status[e]||EMPTY_OBJECT,schema:l,value:b[e],editKey:e,key:f})))}return a}function ObjectField(f){return React.createElement(Widget,_extends({},f,{addKey:function(a,b){var c;if('object'===_typeof(f.value)&&a in f.value)throw new Error('Property "'+a+'" already exists');f.onChange(Object.assign({},f.value,(c={},c[a]=b,c)))},removeKey:function(a){var b=Object.assign({},f.value);delete b[a],f.onChange(b)},alterKey:function(a,b){if(a!==b){if(b in f.value)throw new Error('Property "'+a+'" already exists');var c={};Object.keys(f.value).forEach(function(d){d===a?c[b]=f.value[d]:c[d]=f.value[d]}),f.onChange(c)}}}),renderChildren(f))}var ObjectField$1=validated(ObjectField);function StringField(b){return React.createElement(Widget,b)}var StringField$1=validated(StringField),NumberField=function(e){function a(b){classCallCheck(this,a);var c=possibleConstructorReturn(this,e.call(this,b));return c.state={value:b.value},c.boundChange=c.onChange.bind(c),c}return inherits(a,e),a.prototype.componentWillReceiveProps=function(b){+this.state.value!=+b.value&&this.setState({value:b.value})},a.prototype.onChange=function(e){var a=this,b=''===e?void 0:e,f=+b;this.setState({value:b},function(){return a.props.onChange(isNaN(f)?b:f)})},a.prototype.render=function(){return React.createElement(StringField,_extends({},this.props,{value:this.state.value,onChange:this.boundChange}))},a}(React.Component),NumberField$1=validated(NumberField);function BooleanField(b){return React.createElement(Widget,b)}var BooleanField$1=validated(BooleanField),EMPTY_OBJECT$1={};function onChildChange(e,f){return function(g){var b=f.value;b?f.onChange(b.map(function(c,b){return+b==+e?g:c})):f.onChange([g])}}function onChildRemove(d){return function(e){var a=d.value||[];d.onChange(a.filter(function(d,a){return+a!=+e}))}}function onChildAdd(d){return function(a){var b=d.value||[];d.onChange(b.concat([a]))}}function renderChildren$1(h){var a,f=h.value,b=h.schema,c=b.value,d=b.items;a=f?f:c?c:[];var e=[];return a.forEach(function(a,f){return e.push(React.createElement(SchemaType$1,_extends({},h,{schema:Array.isArray(d)?d[f]||{}:d,value:a,editKey:f+'',status:h.status[f+'']||EMPTY_OBJECT$1,key:f,onChange:onChildChange(f,h)})))}),e}function ArrayField(b){return React.createElement(Widget,_extends({},b,{onChildAdd:onChildAdd(b),onChildRemove:onChildRemove(b)}),renderChildren$1(b))}var ArrayField$1=validated(ArrayField),Fields={object:ObjectField$1,string:StringField$1,number:NumberField$1,boolean:BooleanField$1,array:ArrayField$1};function visibility(e){return function(a){var b=a.schema.visible,c=a.value;try{if(b&&!b(c,a.dispatch(getFormValue),a.path))return null}catch(b){return null}return React.createElement(e,a)}}function Undefined(b){return React.createElement('div',null,'Undefined field type "'+b.schema.type.toString()+'", ['+b.path.toString()+']')}function infer(b){switch('undefined'==typeof b?'undefined':_typeof(b)){case'number':return'number';case'string':return'string';case'boolean':return'boolean';case'object':return Array.isArray(b)?'array':'object';default:return'string';}}function updatePath(c,a){return void 0===a?c:c.concat([a])}function inference(c){var a=function(g){function b(c){classCallCheck(this,b);var a=possibleConstructorReturn(this,g.call(this,c)),d=c.schema,e=d||{};return'type'in e||(e=_extends({type:infer(c.value)},e)),a.state={schema:e},a.path=updatePath(a.props.path,a.props.editKey),a}return inherits(b,g),b.prototype.componentWillReceiveProps=function(c){if((c.editKey!==this.props.editKey||c.path!==this.props.path)&&(this.path=updatePath(c.path,c.editKey)),this.props.schema!==c.schema){var a=c.schema||{};'type'in a||(a=_extends({type:infer(c.value)},a)),this.setState(function(){return{schema:a}})}},b.prototype.render=function(){return React.createElement(c,_extends({},this.props,{path:this.path,schema:this.state.schema}))},b}(React.Component);return a}function updateDefault(e){var a=e.value,b=e.schema.value,c=void 0===a?b:a;return c}function fromDefaultValue(c){var a=function(e){function b(c){classCallCheck(this,b);var a=possibleConstructorReturn(this,e.call(this,c));return a.state={val:updateDefault(c)},a.notifyDefaultChange(),a}return inherits(b,e),b.prototype.componentDidMount=function(){},b.prototype.componentWillReceiveProps=function(b){void 0===b.status.state?this.setState({val:updateDefault(b)}):this.setState({val:b.value})},b.prototype.componentDidUpdate=function(){this.notifyDefaultChange()},b.prototype.notifyDefaultChange=function(){this.props.value!==this.state.val&&this.props.dispatch(setDefaultValue,this.props.path,this.state.val)},b.prototype.render=function(){return React.createElement(c,_extends({},this.props,{value:this.state.val}))},b}(React.Component);return a}var SchemaType=function(e){function a(f){classCallCheck(this,a);var c=possibleConstructorReturn(this,e.call(this,f));return c.onChange=function(){for(var d=arguments.length,a=Array(d),b=0;b<d;b++)a[b]=arguments[b];f.dispatch.apply(f,[update,c.props.path].concat(a))},c}return inherits(a,e),a.prototype.render=function(){var d,c=this.props.schema.type,a=Array.isArray(c)?c.find(function(b){return'null'!==b}):c;return d=void 0===a||'null'===a?Undefined:Fields[a],React.createElement(d,_extends({},this.props,{onChange:this.onChange}))},a}(React.Component);SchemaType.defaultProps={path:[]};var SchemaType$1=inference(fromDefaultValue(visibility(SchemaType))),BranchedSchemaType=higherOrder.branch({schema:'schema',status:'status',value:'value'},SchemaType$1);function noop(){}var Container$1=function(e){function a(b){classCallCheck(this,a);var c=possibleConstructorReturn(this,e.call(this,b));return c.tree=createTree(),c.updateTree(b.value,b.schema),c.rooted=higherOrder.root(c.tree,BranchedSchemaType),c}return inherits(a,e),a.prototype.componentDidMount=function(){var c=this;this.tree.select('value').on('update',function(a){c.event&&c.props.onChange(a.data.currentData,validate(a.data.currentData,c.tree.get('schema'),a.data.currentData).errors)})},a.prototype.componentWillReceiveProps=function(b){b.value===this.tree.get('value')&&b.schema===this.props.schema||this.updateTree(b.value,b.schema)},a.prototype.componentWillUnmount=function(){this.tree.release()},a.prototype.shouldComponentUpdate=function(){return!1},a.prototype.getValue=function(){return this.tree.get('value')},a.prototype.updateTree=function(c,a){this.event=!1,this.tree.set('value',c),this.tree.set('schema',a),this.tree.set('status',{}),this.tree.commit(),this.event=!0},a.prototype.validate=function(){var d=this,a=validate(this.tree.get('value'),this.tree.get('schema'),this.tree.get('value')),e=new Map;return a.errors.forEach(function(c){var a=e.get(c.property)||[];a.push(c.message),e.set(c.property,a)}),e.forEach(function(a,b){setErrors(d.tree,b.split(/\.|\[|\]/).filter(function(b){return''!==b}).slice(1),a)}),a.errors},a.prototype.render=function(){var b=this.rooted;return React.createElement(b,{onChange:noop,path:[]})},a}(React.Component);Container$1.defaultProps={schema:{}},exports['default']=Container$1,exports.setDefaultWidgets=setDefaultWidgets;
//# sourceMappingURL=index.js.map
