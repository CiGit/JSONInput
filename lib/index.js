'use strict';function _interopDefault(n){return n&&'object'==typeof n&&'default'in n?n['default']:n}var React=_interopDefault(require('react')),propTypes=_interopDefault(require('prop-types')),baobabReact_higherOrder=require('baobab-react/higher-order'),Baobab=_interopDefault(require('baobab')),shouldPureComponentUpdate=_interopDefault(require('react-pure-render/function')),jsonschema=require('jsonschema'),jsonschema__default=_interopDefault(jsonschema),createTree=function(){return new Baobab({schema:{},value:{},status:{}})};function undefinedWidgetFactory(n){return function(){return React.createElement('span',null,'Widget for \''+n+'\' was not defined')}}function labeled(n){function o(p){var q=p.schema.required,r=q?'required':'';return React.createElement('div',null,React.createElement('label',{className:p.schema.type+'Field '+r},React.createElement('span',{className:'title'},p.view.title||p.editKey),React.createElement(n,p),React.createElement('span',null,p.view.description),React.createElement('span',null,p.errorMessage)))}return o.defaultProps={editKey:'',errorMessage:[]},o}function onInputChange(n){return function(o){'checkbox'===o.target.type?n(o.target.checked):n(o.target.value)}}function Input(n){return React.createElement('input',{type:n.type,placeholder:n.schema.placeholder,value:n.value,className:n.className,onChange:onInputChange(n.onChange),checked:n.checked})}Input.defaultProps={className:void 0,checked:!1};var _typeof='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(n){return typeof n}:function(n){return n&&'function'==typeof Symbol&&n.constructor===Symbol&&n!==Symbol.prototype?'symbol':typeof n},classCallCheck=function(n,o){if(!(n instanceof o))throw new TypeError('Cannot call a class as a function')},_extends=Object.assign||function(n){for(var p,o=1;o<arguments.length;o++)for(var q in p=arguments[o],p)Object.prototype.hasOwnProperty.call(p,q)&&(n[q]=p[q]);return n},inherits=function(n,o){if('function'!=typeof o&&null!==o)throw new TypeError('Super expression must either be null or a function, not '+typeof o);n.prototype=Object.create(o&&o.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),o&&(Object.setPrototypeOf?Object.setPrototypeOf(n,o):n.__proto__=o)},objectWithoutProperties=function(n,o){var p={};for(var q in n)0<=o.indexOf(q)||Object.prototype.hasOwnProperty.call(n,q)&&(p[q]=n[q]);return p},possibleConstructorReturn=function(n,o){if(!n)throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called');return o&&('object'==typeof o||'function'==typeof o)?o:n};function TextWidget(n){return React.createElement(Input,_extends({},n,{type:'string'}))}var TextWidget$1=labeled(TextWidget);function ArrowNumberWidget(n){return React.createElement(Input,_extends({},n,{type:'number'}))}var ArrowNumberWidget$1=labeled(ArrowNumberWidget);function CheckboxWidget(n){return React.createElement(Input,_extends({},n,{type:'checkbox',checked:n.value}))}CheckboxWidget.defaultProps={value:!1};var CheckboxWidget$1=labeled(CheckboxWidget);function ArrayWidget(n){var o=React.Children.map(n.children,function(p,q){return React.createElement('div',null,React.createElement('button',{onClick:n.onChildRemove(q)},'-'),p)});return React.createElement('div',null,React.createElement('div',null,o),React.createElement('button',{onClick:n.onChildAdd},'+'))}var ArrayWidget$1=labeled(ArrayWidget);function ObjectWidget(n){return React.createElement('div',null,n.children)}var ObjectWidget$1=labeled(ObjectWidget);function SelectWidget(n){var o=n.view,p=n.value,q=n.onChange,r=o.choices.map(function(s){return React.createElement('option',{key:s.value,value:s.value},s.label)});return React.createElement('select',{value:p,onChange:function(t){return q(t.target.value)}},r)}var DefaultWidget={string:TextWidget$1,number:TextWidget$1,boolean:CheckboxWidget$1,array:ArrayWidget$1,object:ObjectWidget$1,arrowNumber:ArrowNumberWidget$1,select:SelectWidget};function defaultWidget(n){return DefaultWidget[n]||undefinedWidgetFactory(n)}function setDefaultWidgets(n){DefaultWidget=Object.assign({},DefaultWidget,n)}var EMPTYOBJECT={};function Widget(n){var o=n.schema,p=o.view,q=objectWithoutProperties(o,['view']);if(p){var r=p.type;if('string'==typeof r){var s=defaultWidget(r);return React.createElement(s,_extends({},n,{schema:q,view:p}))}if('function'==typeof r)return React.createElement(r,_extends({},n,{schema:q,view:p}))}var t=Array.isArray(o.type)?o.type.find(function(v){return'null'!==v}):o.type,u=defaultWidget(t);return React.createElement(u,_extends({},n,{schema:q,view:p||EMPTYOBJECT}))}var customValidator=new jsonschema.Validator;customValidator.attributes.errored=function(n,o,p){if('function'!=typeof o.errored)throw new jsonschema__default.SchemaError('"errored" expects a function');var q=o.errored(n,p.formValue);return q?q:void 0};function validate(n,o,p){return customValidator.validate(n,o,{formValue:p})}function validated$1(n){return function(o){return React.createElement(n,_extends({},o,{errorMessage:o.actions.getErrors(o.path),onChange:function(p){var q=validate(p,o.schema,o.actions.getFormValue()),r=q.errors.map(function(s){return s.message});o.onChange(p,r)}}))}}function renderChildren(n){function o(w){return q[w]&&'number'==typeof q[w].index?q[w].index:0}var p=[],q=n.schema.properties||{},r=n.value||{},s=Object.keys(q);Object.keys(r).forEach(function(w){w in q||s.push(w)}),s.sort(function(w,x){return o(w)-o(x)});for(var t,u=0;u<s.length;u+=1)if(t=s[u],t in q)p.push(React.createElement(SchemaType$1,_extends({},n,{schema:q[t],value:r[t],editKey:t,key:t})));else{var v=n.schema.defaultProperties;v&&n.actions.updateSchema(n.path.concat([t]),v),p.push(React.createElement(SchemaType$1,_extends({},n,{schema:v,value:r[t],editKey:t,key:t})))}return p}function ObjectField(n){return React.createElement(Widget,_extends({},n,{addKey:function(o,p){var q;n.onChange(Object.assign({},n.value,(q={},q[o]=p,q)))},removeKey:function(o){var p=Object.assign({},n.value);delete p[o],n.actions.deleteSchema(n.path.concat([o]),{}),n.onChange(p)},alterKey:function(o,p){var q={};Object.keys(n.value).forEach(function(r){r===o?q[p]=n.value[r]:q[r]=n.value[r]}),n.onChange(q)}}),renderChildren(n))}ObjectField.defaultProps={value:{}};var ObjectField$1=validated$1(ObjectField);function StringField(n){var o=void 0!==n.value&&null!==n.value?n.value+'':n.value;return React.createElement(Widget,_extends({},n,{value:o}))}var StringField$1=validated$1(StringField),NumberField=function(n){function o(p){classCallCheck(this,o);var q=possibleConstructorReturn(this,n.call(this,p));return q.state={value:p.value},q.boundChange=q.onChange.bind(q),q}return inherits(o,n),o.prototype.componentWillReceiveProps=function(q){+this.state.value!=+q.value&&this.setState({value:q.value})},o.prototype.onChange=function(q){var r=this,s=''===q?void 0:q,t=+s;this.setState({value:s},function(){return r.props.onChange(isNaN(t)?s:t)})},o.prototype.render=function(){return React.createElement(StringField,_extends({},this.props,{value:this.state.value,onChange:this.boundChange}))},o}(React.Component),NumberField$1=validated$1(NumberField);function BooleanField(n){return React.createElement(Widget,n)}var BooleanField$1=validated$1(BooleanField);function onChildChange(n,o){return function(p){var q=o.value;q?o.onChange(q.map(function(r,s){return+s==+n?p:r})):o.onChange([p])}}function onChildRemove(n){return function(o){return function(){var p=n.value||[];n.onChange(p.filter(function(q,r){return+r!=+o}))}}}function onChildAdd(n){return function(){var o=n.value||[];n.onChange(o.concat([void 0]))}}function renderChildren$1(n){var o=n.value,p=n.schema,q=p.defaultValue,r=p.items,s;s=o?o:q?q:[];var t=[];return s.forEach(function(u,v){return t.push(React.createElement(SchemaType$1,_extends({},n,{schema:Array.isArray(r)?r[v]||{}:r,value:u,editKey:v+'',key:v,onChange:onChildChange(v,n)})))}),t}function ArrayField(n){return React.createElement(Widget,_extends({},n,{onChildAdd:onChildAdd(n),onChildRemove:onChildRemove(n)}),renderChildren$1(n))}var ArrayField$1=validated$1(ArrayField),Fields={object:ObjectField$1,string:StringField$1,number:NumberField$1,boolean:BooleanField$1,array:ArrayField$1};function visibility$1(n){return function(o){var p=o.schema.visible,q=o.value;return p&&!p(q,o.actions.getFormValue())?null:React.createElement(n,o)}}function Undefined(n){return React.createElement('span',null,'Undefined field type "'+n.schema.type+'", ['+n.path+']')}function infer(n){switch('undefined'==typeof n?'undefined':_typeof(n)){case'number':return'number';case'string':return'string';case'boolean':return'boolean';case'object':return Array.isArray(n)?'array':'object';default:return'string';}}function updatePath(n,o){return o?n.concat([o]):n}function inference(n){return function(o){var p=o.schema,q=updatePath(o.path,o.editKey),r=p;return r&&'type'in r||(r={type:infer(o.value)}),React.createElement(n,_extends({},o,{path:q,schema:r}))}}function updateDefault(n){var o=n.value,p=n.schema.value,q=void 0===o?p:o;return q}function fromDefaultValue(n){var o=function(p){function q(r){classCallCheck(this,q);var s=possibleConstructorReturn(this,p.call(this,r));return s.state={val:updateDefault(r)},s}return inherits(q,p),q.prototype.componentDidMount=function(){this.notifyDefaultChange()},q.prototype.componentWillReceiveProps=function(s){this.setState({val:updateDefault(s)})},q.prototype.componentDidUpdate=function(){this.notifyDefaultChange()},q.prototype.notifyDefaultChange=function(){this.props.value!==this.state.val&&this.props.actions.setDefaultValue(this.props.path,this.state.val)},q.prototype.render=function(){return React.createElement(n,_extends({},this.props,{value:this.state.val}))},q}(React.Component);return o}function doAction(n,o){return function(){for(var p=arguments.length,q=Array(p),r=0;r<p;r++)q[r]=arguments[r];n.apply(void 0,[o].concat(q))}}var SchemaType=function(n){function o(p){classCallCheck(this,o);var q=possibleConstructorReturn(this,n.call(this,p));return q.onChange=doAction(p.actions.update,p.path),q}return inherits(o,n),o.prototype.shouldComponentUpdate=function(){for(var q=arguments.length,r=Array(q),s=0;s<q;s++)r[s]=arguments[s];return shouldPureComponentUpdate.apply(this,r)},o.prototype.render=function(){var q=this.props.schema.type,r=Array.isArray(q)?q.find(function(t){return'null'!==t}):q,s=Fields[r]||Undefined;return React.createElement(s,_extends({},this.props,{onChange:this.onChange}))},o}(React.Component),SchemaType$1=inference(fromDefaultValue(visibility$1(SchemaType))),VALUE='value',STATUS='status',STATE='state',ERRORS='errors',NOERRORS=[];function setErrors(n,o,p){var q=[STATUS].concat(o).concat([ERRORS]),r=n.select(q);p&&p.length&&Array.isArray(r.get())?(r.splice([0,r.get().length]),r.concat(p||[])):r.set(p||NOERRORS)}function update(n,o,p,q){var r=[STATUS].concat(o);n.set([VALUE].concat(o),p),n.set(r.concat([STATE]),'dirty'),setErrors(n,o,q)}function setDefaultValue(n,o,p){n.set([VALUE].concat(o),p),n.set([STATUS].concat(o).concat([STATE]),'pristine')}function getStatus(n,o){return n.get([STATUS].concat(o).concat([STATE]))}function getErrors(n,o){return n.get([STATUS].concat(o).concat([ERRORS]))||NOERRORS}function getFormValue(n){return n.get(VALUE)}function schemaPath(n,o){return o.reduce(function(p,q){return'object'===n.get(p).type?p.concat(['properties',q]):'array'===n.get(p).type?p.concat(['items']):p.concat([q])},['schema'])}function updateSchema(n,o,p){var q=schemaPath(n,o);n.set(q,p)}function deleteSchema(n,o){var p=schemaPath(n,o);n.unset(p)}var actions=Object.freeze({setErrors:setErrors,update:update,setDefaultValue:setDefaultValue,getStatus:getStatus,getErrors:getErrors,getFormValue:getFormValue,updateSchema:updateSchema,deleteSchema:deleteSchema}),BranchedSchemaType=baobabReact_higherOrder.branch({schema:'schema',status:'status',value:'value'},SchemaType$1),TYPES=['string','number','boolean','object','array','null'],Container$1=function(n){function o(p){classCallCheck(this,o);var q=possibleConstructorReturn(this,n.call(this,p));return q.tree=createTree(),q.updateTree(p.value,p.schema),q.ACTIONS={},Object.keys(actions).forEach(function(r){return q.ACTIONS[r]=actions[r].bind(q.tree,q.tree)}),q.rooted=baobabReact_higherOrder.root(q.tree,BranchedSchemaType),q}return inherits(o,n),o.prototype.componentWillReceiveProps=function(q){this.updateTree(q.value,q.schema)},o.prototype.shouldComponentUpdate=function(){return!1},o.prototype.componentWillUnmount=function(){this.tree.release()},o.prototype.getValue=function(){return this.tree.get('value')},o.prototype.updateTree=function(q,r){var s=this;this.tree.select('value').release(),this.tree.select('value').set(q),this.tree.select('schema').set(r),this.tree.select('status').release(),this.tree.commit(),this.tree.select('value').on('update',function(t){return s.props.onChange(t.data.currentData,validate(t.data.currentData,s.tree.get('schema'),t.data.currentData).errors)})},o.prototype.validate=function(){var q=validate(this.tree.get('value'),this.tree.get('schema'),this.tree.get('value')),r=this.ACTIONS.setErrors,s=new Map;return q.errors.forEach(function(t){var u=s.get(t.property)||[];u.push(t.message),s.set(t.property,u)}),s.forEach(function(t,u){r(u.split(/\.|\[|\]/).filter(function(v){return''!==v}).slice(1),t)}),q.errors},o.prototype.render=function(){var q=this.rooted;return React.createElement(q,{onChange:this.props.onChange,path:[],actions:this.ACTIONS})},o}(React.Component);Container$1.defaultProps={schema:{}},Container$1.setDefaultWidgets=setDefaultWidgets,module.exports=Container$1;
//# sourceMappingURL=index.js.map
