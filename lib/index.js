"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t=require("react"),n=e(require("immer")),r=require("jsonschema"),a=require("lodash-es"),o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},u=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},c=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},s=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},l=t.createContext({value:void 0,schema:{},status:{}}),h=l.Consumer,p=function(e){function r(){u(this,r);var t=s(this,e.apply(this,arguments));return t.state={schema:{},value:{},status:{}},t.dispatch=function(e){for(var r=arguments.length,a=Array(r>1?r-1:0),o=1;o<r;o++)a[o-1]=arguments[o];t.setState(function(t){return n(e).apply(void 0,[t].concat(a))})},t}return c(r,e),r.getDerivedStateFromProps=function(e,t){return t.schema!==e.schema||t.value!==e.value?{value:e.value,schema:e.schema,status:{}}:null},r.prototype.shouldComponentUpdate=function(e,t){return this.state!==t},r.prototype.componentDidUpdate=function(e,t){this.state.value!==t.value&&this.props.onValueChange(this.state.value)},r.prototype.render=function(){return t.createElement(l.Provider,{value:this.state},this.props.children(i({},this.state,{dispatch:this.dispatch})))},r}(t.Component);function f(e){return function(){return t.createElement("span",null,"Widget for '"+e+"' was not defined")}}var v={};function d(e){return v[e]||f(e)}function m(e){v=Object.assign({},v,e)}var y={};function g(e){var n=e.value,r=e.schema,a=e.schema.view,o={value:n,schema:r,children:e.children,editKey:e.editKey,path:e.path,onChange:e.onChange,onChildAdd:e.onChildAdd,onChildRemove:e.onChildRemove,addKey:e.addKey,removeKey:e.removeKey,alterKey:e.alterKey,errorMessage:e.errorMessage};if(a){var u=a.type;if("string"==typeof u){var c=d(u);return t.createElement(c,i({},o,{view:a}))}if("function"==typeof u){var s=u;return t.createElement(s,i({},o,{view:a}))}}var l=Array.isArray(r.type)?r.type.find(function(e){return"null"!==e}):r.type,h=void 0;return h=d(void 0===l?"undefinedType":l),t.createElement(h,i({},o,{view:a||y}))}var b=new r.Validator;function C(e,t,n){return b.validate(e,t,{formValue:n||{}})}b.attributes.errored=function(e,t,n){if("function"!=typeof t.errored)throw new r.SchemaError('"errored" expects a function');var a=t.errored(e,n.formValue);if(a)return a};var E="value",w="status",j="$$$state",S="$$$errors",K=[];function P(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments[2],r=[w].concat(t).concat([S]);a.set(e,r,n)}function O(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments[2],r=new Map;n.forEach(function(e){var t=r.get(e.property)||[];t.push(e.message),r.set(e.property,t)}),P(e,t,K),r.forEach(function(n,r){P(e,t.concat(r.split(/\.|\[|\]/).filter(function(e){return""!==e}).slice(1)),n)})}function A(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments[2],r=arguments[3],o=[w].concat(t);a.set(e,[E].concat(t),n),a.set(e,o.concat([j]),"dirty"),O(e,t,r)}function x(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];A(e,t,arguments[2],[]),a.set(e,[w].concat(t).concat([j]),"pristine")}function $(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];try{a.unset(e,[w].concat(t))}catch(e){}}function k(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return a.get(e,[w].concat(t).concat([S]))||K}function D(e){return function(n){return t.createElement(h,null,function(r){return t.createElement(e,i({},n,{errorMessage:k(r,n.path),onChange:function(e){var t=C(e,n.schema,r.value);n.onChange(e,t.errors)}}))})}}function N(e,t){var n=e.properties,r=void 0===n?{}:n;if(t in r)return r[t]}function V(e,t){var n=e.patternProperties||{},r=Object.keys(n).find(function(e){return new RegExp(e).test(t)});if(r)return n[r]}function _(e,t){return N(e,t)||V(e,t)||e.additionalProperties}var M={};function R(e){var n=[],r=e.schema.properties||{},a=e.value||{},o=Object.keys(r);function u(e){if(r[e]){var t=r[e].index;if("number"==typeof t)return t}return 0}Object.keys(a).forEach(function(e){e in r||o.push(e)}),o.sort(function(e,t){return u(e)-u(t)});for(var c=0;c<o.length;c+=1){var s=o[c],l=_(e.schema,s);n.push(t.createElement(se,i({},e,{status:e.status[s]||M,schema:l,value:a[s],editKey:s,key:c})))}return n}function q(e){return t.createElement(g,i({},e,{addKey:function(t,n){var r;if("object"===o(e.value)&&t in e.value)throw new Error('Property "'+t+'" already exists');e.onChange(Object.assign({},e.value,((r={})[t]=n,r)))},removeKey:function(t){var n=Object.assign({},e.value);delete n[t],e.onChange(n)},alterKey:function(t,n){if(t!==n){if(n in e.value)throw new Error('Property "'+n+'" already exists');var r={};Object.keys(e.value).forEach(function(a){a!==t?r[a]=e.value[a]:r[n]=e.value[a]}),e.onChange(r)}}}),R(e))}var F=D(q);function U(e){return t.createElement(g,e)}var T=D(U);function W(e){switch(void 0===e?"undefined":o(e)){case"number":return e;case"string":return""===e?void 0:Number(e);default:return}}var z=function(e){function n(){u(this,n);var t=s(this,e.apply(this,arguments));return t.state={value:t.props.value},t.onChange=function(e){var n=""===e?void 0:e,r=Number(n);t.setState({value:n},function(){return t.props.onChange(isNaN(r)?n:r)})},t}return c(n,e),n.prototype.render=function(){return t.createElement(U,i({},this.props,{value:this.state.value,onChange:this.onChange}))},n}(t.Component);z.getDerivedStateFromProps=function(e,t){return W(t.value)!==W(e.value)?{value:e.value}:null};var B=D(z);function G(e){return t.createElement(g,e)}var H=D(G),I={};function J(e,t){return function(n){var r=t.value;r?t.onChange(r.map(function(t,r){return+r!=+e?t:n})):t.onChange([n])}}function L(e){return function(t){var n=e.value||[];e.onChange(n.filter(function(e,n){return Number(n)!==Number(t)}))}}function Q(e){return function(t){var n=e.value||[];e.onChange(n.concat([t]))}}function X(e){var n=e.value,r=e.schema,a=r.value,o=r.items,u=[];return(n||(a||[])).forEach(function(n,r){return u.push(t.createElement(se,i({},e,{schema:Array.isArray(o)?o[r]||{}:o,value:n,editKey:String(r),status:e.status[String(r)]||I,key:r,onChange:J(r,e)})))}),u}function Y(e){return t.createElement(g,i({},e,{onChildAdd:Q(e),onChildRemove:L(e)}),X(e))}var Z=D(Y),ee={object:F,string:T,number:B,boolean:H,array:Z};function te(e){return function(n){var r=n.schema.visible,a=n.value;return t.createElement(h,null,function(o){var u=o.value;try{if(r&&!r(a,u,n.path.concat()))return null}catch(e){return null}return t.createElement(e,n)})}}function ne(e){return t.createElement("div",null,'Undefined field type "'+e.schema.type.toString()+'", ['+e.path.toString()+"]")}function re(e){switch(void 0===e?"undefined":o(e)){case"number":return"number";case"string":return"string";case"boolean":return"boolean";case"object":return Array.isArray(e)?"array":"object";default:return"string"}}function ae(e,t){return void 0!==t?e.concat([t]):e}function oe(e){return function(n){function r(){u(this,r);var e=s(this,n.apply(this,arguments));return e.state={path:[],schema:{},oldPath:null,oldEditKey:null,oldSchema:null},e}return c(r,n),r.getDerivedStateFromProps=function(e,t){var n={};if(t.oldEditKey===e.editKey&&t.oldPath===e.path||(n.path=ae(e.path,e.editKey),n.oldPath=e.path,n.oldEditKey=e.editKey),t.oldSchema!==e.schema){var r=e.schema||{};"type"in r||(r=i({type:re(e.value)},r)),n.schema=r,n.oldSchema=e.schema}return n},r.prototype.render=function(){return t.createElement(e,i({},this.props,{path:this.state.path,schema:this.state.schema}))},r}(t.Component)}function ue(e){var t=e.value,n=e.schema.value,r=e.dispatch,a=e.path,o=void 0!==t?t:n;return o!==t&&r(x,a,o),o}function ie(e){return function(n){function r(){u(this,r);var e=s(this,n.apply(this,arguments));return e.state={val:void 0},e}return c(r,n),r.getDerivedStateFromProps=function(e){return void 0===e.status.$$$state?{val:ue(e)}:{val:e.value}},r.prototype.render=function(){return t.createElement(e,i({},this.props,{value:this.state.val}))},r}(t.Component)}var ce=function(e){function n(t){u(this,n);var r=s(this,e.call(this,t));return r.onChange=r.onChange.bind(r),r}return c(n,e),n.prototype.onChange=function(){for(var e,t=arguments.length,n=Array(t),r=0;r<t;r++)n[r]=arguments[r];(e=this.props).dispatch.apply(e,[A,this.props.path].concat(n))},n.prototype.componentWillUnmount=function(){this.props.dispatch($,this.props.path)},n.prototype.render=function(){var e=this.props.schema.type,n=Array.isArray(e)?e.find(function(e){return"null"!==e}):e,r=void 0;return void 0===(r=void 0===n||"null"===n?ne:ee[n])&&(r=ne),t.createElement(r,i({},this.props,{onChange:this.onChange}))},n}(t.Component);ce.defaultProps={path:[]};var se=oe(ie(te(ce))),le=[];function he(){}var pe=function(e){function n(){u(this,n);var t=s(this,e.apply(this,arguments));return t.store=null,t}return c(n,e),n.prototype.getValue=function(){return this.store.state.value},n.prototype.validate=function(){var e=C(this.store.state.value,this.store.state.schema,this.store.state.value);return this.store.dispatch(O,[],e.errors),e.errors},n.prototype.render=function(){var e=this;return t.createElement(p,{ref:function(t){e.store=t},value:this.props.value,schema:this.props.schema,onValueChange:function(t){return e.props.onChange(t,C(t,e.props.schema,t).errors)}},function(e){var n=e.schema,r=e.value,a=e.status,o=e.dispatch;return t.createElement(se,{schema:n,dispatch:o,value:r,path:le,onChange:he,status:a})})},n}(t.Component);pe.defaultProps={schema:{}},exports.default=pe,exports.setDefaultWidgets=m;
//# sourceMappingURL=index.js.map
