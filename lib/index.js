"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}function updateDefault(e){var t=e.value,n=e.schema.value,a=void 0!==t?t:n;return a}function fromDefaultValue(e){var t=function(t){function n(e){classCallCheck(this,n);var a=possibleConstructorReturn(this,t.call(this,e));return a.state={val:updateDefault(e)},a}return inherits(n,t),n.prototype.componentDidMount=function(){this.notifyDefaultChange()},n.prototype.componentWillReceiveProps=function(e){this.setState({val:updateDefault(e)})},n.prototype.componentDidUpdate=function(){this.notifyDefaultChange()},n.prototype.notifyDefaultChange=function(){this.props.value!==this.state.val&&this.props.actions.setDefaultValue(this.props.path,this.state.val)},n.prototype.render=function(){return React__default.createElement(e,_extends({},this.props,{value:this.state.val}))},n}(React__default.Component);return t}function undefinedWidgetFactory(e){return function(){return React__default.createElement("span",null,"Widget for '"+e+"' was not defined")}}function labeled(e){function t(t){var n=t.schema.required,a=n?"required":"";return React__default.createElement("div",null,React__default.createElement("label",{className:t.schema.type+"Field "+a},React__default.createElement("span",{className:"title"},t.view.title||t.editKey),React__default.createElement(e,t),React__default.createElement("span",null,t.view.description),React__default.createElement("span",null,t.errorMessage)))}return t.defaultProps={editKey:"",errorMessage:[]},t}function onInputChange(e){return function(t){e("checkbox"===t.target.type?t.target.checked:t.target.value)}}function Input(e){return React__default.createElement("input",{type:e.type,placeholder:e.schema.placeholder,value:e.value,className:e.className,onChange:onInputChange(e.onChange),checked:e.checked})}function TextWidget(e){return React__default.createElement(Input,_extends({},e,{type:"string"}))}function ArrowNumberWidget(e){return React__default.createElement(Input,_extends({},e,{type:"number"}))}function CheckboxWidget(e){return React__default.createElement(Input,_extends({},e,{type:"checkbox",checked:e.value}))}function ArrayWidget(e){function t(t,n){return React__default.createElement("div",null,React__default.createElement("button",{onClick:e.onChildRemove(n)},"-"),t)}var n=React__default.Children.map(e.children,t);return React__default.createElement("div",null,React__default.createElement("div",null,n),React__default.createElement("button",{onClick:e.onChildAdd},"+"))}function ObjectWidget(e){return React__default.createElement("div",null,e.children)}function SelectWidget(e){var t=e.view,n=e.value,a=e.onChange,r=t.choices.map(function(e){return React__default.createElement("option",{key:e.value,value:e.value},e.label)});return React__default.createElement("select",{value:n,onChange:function(e){return a(e.target.value)}},r)}function defaultWidget(e){return DefaultWidget[e]||undefinedWidgetFactory(e)}function setDefaultWidgets(e){DefaultWidget=Object.assign({},DefaultWidget,e)}function Widget(e){var t=e.schema,n=t.view,a=objectWithoutProperties(t,["view"]);if(n){var r=n.type;if("string"==typeof r){var o=defaultWidget(r);return React__default.createElement(o,_extends({},e,{schema:a,view:n}))}if("function"==typeof r){var u=r;return React__default.createElement(u,_extends({},e,{schema:a,view:n}))}}var c=Array.isArray(t.type)?t.type.find(function(e){return"null"!==e}):t.type,i=defaultWidget(c);return React__default.createElement(i,_extends({},e,{schema:a,view:n||EMPTYOBJECT}))}function validate(e,t,n){return customValidator.validate(e,t,{formValue:n})}function validated$1(e){function t(t){function n(e){var n=validate(e,t.schema,t.actions.getFormValue()),a=n.errors.map(function(e){return e.message});t.onChange(e,a)}return React__default.createElement(e,_extends({},t,{errorMessage:t.actions.getErrors(t.path),onChange:n}))}return t}function renderChildren(e){function t(e,t){var n=a[e]?a[e].index||0:0,r=a[t]?a[t].index||0:0;return n-r}var n=[],a=e.schema.properties||{},r=e.value||{},o=Object.keys(a);Object.keys(r).forEach(function(e){e in a||o.push(e)}),o.sort(t);for(var u=0;u<o.length;u+=1){var c=o[u];if(c in a)n.push(React__default.createElement(SchemaType$1,_extends({},e,{schema:a[c],value:r[c],editKey:c,key:c})));else{var i=e.schema.defaultProperties;i&&e.actions.updateSchema(e.path.concat([c]),i),n.push(React__default.createElement(SchemaType$1,_extends({},e,{schema:i,value:r[c],editKey:c,key:c})))}}return n}function ObjectField(e){function t(t,n){var a;e.onChange(Object.assign({},e.value,(a={},a[t]=n,a)))}function n(t){var n=Object.assign({},e.value);delete n[t],e.actions.deleteSchema(e.path.concat([t]),{}),e.onChange(n)}function a(t,n){var a={};Object.keys(e.value).forEach(function(r){r!==t?a[r]=e.value[r]:a[n]=e.value[r]}),e.onChange(a)}return React__default.createElement(Widget,_extends({},e,{addKey:t,removeKey:n,alterKey:a}),renderChildren(e))}function StringField(e){var t=void 0!==e.value&&null!==e.value?String(e.value):e.value;return React__default.createElement(Widget,_extends({},e,{value:t}))}function BooleanField(e){return React__default.createElement(Widget,e)}function onChildChange(e,t){return function(n){var a=t.value;a?t.onChange(a.map(function(t,a){return+a!==+e?t:n})):t.onChange([n])}}function onChildRemove(e){return function(t){return function(){var n=e.value||[];e.onChange(n.filter(function(e,n){return Number(n)!==Number(t)}))}}}function onChildAdd(e){return function(){var t=e.value||[];e.onChange(t.concat([void 0]))}}function renderChildren$1(e){var t=e.value,n=e.schema,a=n.defaultValue,r=n.items,o=void 0;o=t?t:a?a:[];var u=[];return o.forEach(function(t,n){return u.push(React__default.createElement(SchemaType$1,_extends({},e,{schema:Array.isArray(r)?r[n]||{}:r,value:t,editKey:String(n),key:n,onChange:onChildChange(n,e)})))}),u}function ArrayField(e){return React__default.createElement(Widget,_extends({},e,{onChildAdd:onChildAdd(e),onChildRemove:onChildRemove(e)}),renderChildren$1(e))}function visibility$1(e){function t(t){var n=t.schema.visible,a=t.value;return n&&!n(a,t.actions.getFormValue())?null:React__default.createElement(e,t)}return t}function Undefined(e){return React__default.createElement("span",null,'Undefined field type "'+e.schema.type+'", ['+e.path+"]")}function infer(e){switch("undefined"==typeof e?"undefined":_typeof(e)){case"number":return"number";case"string":return"string";case"boolean":return"boolean";case"object":return Array.isArray(e)?"array":"object";default:return"string"}}function updatePath(e,t){return t?e.concat([t]):e}function inference(e){function t(t){var n=t.schema,a=updatePath(t.path,t.editKey),r=n;return r&&"type"in r||(r={type:infer(t.value)}),React__default.createElement(e,_extends({},t,{path:a,schema:r}))}return t}function doAction(e,t){return function(){for(var n=arguments.length,a=Array(n),r=0;r<n;r++)a[r]=arguments[r];e.apply(void 0,[t].concat(a))}}function setErrors(e,t,n){var a=[STATUS].concat(t).concat([ERRORS]),r=e.select(a);n&&n.length&&Array.isArray(r.get())?(r.splice([0,r.get().length]),r.concat(n||[])):r.set(n||NOERRORS)}function update(e,t,n,a){var r=[STATUS].concat(t);e.set([VALUE].concat(t),n),e.set(r.concat([STATE]),"dirty"),setErrors(e,t,a)}function setDefaultValue(e,t,n){e.set([VALUE].concat(t),n),e.set([STATUS].concat(t).concat([STATE]),"pristine")}function getStatus(e,t){return e.get([STATUS].concat(t).concat([STATE]))}function getErrors(e,t){return e.get([STATUS].concat(t).concat([ERRORS]))||NOERRORS}function getFormValue(e){return e.get(VALUE)}function schemaPath(e,t){return t.reduce(function(t,n){return"object"===e.get(t).type?t.concat(["properties",n]):"array"===e.get(t).type?t.concat(["items"]):t.concat([n])},["schema"])}function updateSchema(e,t,n){var a=schemaPath(e,t);e.set(a,n)}function deleteSchema(e,t){var n=schemaPath(e,t);e.unset(n)}var React=require("react"),React__default=_interopDefault(React),baobabReact_higherOrder=require("baobab-react/higher-order"),Baobab=_interopDefault(require("baobab")),shouldPureComponentUpdate=_interopDefault(require("react-pure-render/function")),jsonschema=require("jsonschema"),jsonschema__default=_interopDefault(jsonschema),createTree=function(){return new Baobab({schema:{},value:{},status:{}})},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},_extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},inherits=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},objectWithoutProperties=function(e,t){var n={};for(var a in e)t.indexOf(a)>=0||Object.prototype.hasOwnProperty.call(e,a)&&(n[a]=e[a]);return n},possibleConstructorReturn=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t};Input.defaultProps={className:void 0,checked:!1};var TextWidget$1=labeled(TextWidget),ArrowNumberWidget$1=labeled(ArrowNumberWidget);CheckboxWidget.defaultProps={value:!1};var CheckboxWidget$1=labeled(CheckboxWidget),ArrayWidget$1=labeled(ArrayWidget),ObjectWidget$1=labeled(ObjectWidget),DefaultWidget={string:TextWidget$1,number:TextWidget$1,boolean:CheckboxWidget$1,array:ArrayWidget$1,object:ObjectWidget$1,arrowNumber:ArrowNumberWidget$1,select:SelectWidget},EMPTYOBJECT={},customValidator=new jsonschema.Validator;customValidator.attributes.errored=function(e,t,n){if("function"!=typeof t.errored)throw new jsonschema__default.SchemaError('"errored" expects a function');var a=t.errored(e,n.formValue);if(a)return a},ObjectField.defaultProps={value:{}};var ObjectField$1=validated$1(fromDefaultValue(ObjectField)),StringField$1=validated$1(fromDefaultValue(StringField)),NumberField=function(e){function t(n){classCallCheck(this,t);var a=possibleConstructorReturn(this,e.call(this,n));return a.state={value:n.value},a.boundChange=a.onChange.bind(a),a}return inherits(t,e),t.prototype.componentWillReceiveProps=function(e){Number(this.state.value)!==Number(e.value)&&this.setState({value:e.value})},t.prototype.onChange=function(e){var t=this,n=""===e?void 0:e,a=Number(n);this.setState({value:n},function(){return t.props.onChange(isNaN(a)?n:a)})},t.prototype.render=function(){return React__default.createElement(StringField,_extends({},this.props,{value:this.state.value,onChange:this.boundChange}))},t}(React__default.Component),NumberField$1=validated$1(fromDefaultValue(NumberField)),BooleanField$1=validated$1(fromDefaultValue(BooleanField)),ArrayField$1=fromDefaultValue(ArrayField),Fields={object:ObjectField$1,string:StringField$1,number:NumberField$1,boolean:BooleanField$1,array:ArrayField$1},SchemaType=function(e){function t(n){classCallCheck(this,t);var a=possibleConstructorReturn(this,e.call(this,n));return a.onChange=doAction(n.actions.update,n.path),a}return inherits(t,e),t.prototype.shouldComponentUpdate=function(){for(var e=arguments.length,t=Array(e),n=0;n<e;n++)t[n]=arguments[n];return shouldPureComponentUpdate.apply(this,t)},t.prototype.render=function(){var e=this.props.schema.type,t=Array.isArray(e)?e.find(function(e){return"null"!==e}):e,n=Fields[t]||Undefined;return React__default.createElement(n,_extends({},this.props,{onChange:this.onChange}))},t}(React__default.Component),SchemaType$1=inference(visibility$1(SchemaType)),VALUE="value",STATUS="status",STATE="state",ERRORS="errors",NOERRORS=[],actions=Object.freeze({setErrors:setErrors,update:update,setDefaultValue:setDefaultValue,getStatus:getStatus,getErrors:getErrors,getFormValue:getFormValue,updateSchema:updateSchema,deleteSchema:deleteSchema}),BranchedSchemaType=baobabReact_higherOrder.branch({schema:"schema",status:"status",value:"value"},SchemaType$1),Container$1=function(e){function t(n){classCallCheck(this,t);var a=possibleConstructorReturn(this,e.call(this,n));return a.tree=createTree(),a.updateTree(n.value,n.schema),a.ACTIONS={},Object.keys(actions).forEach(function(e){return a.ACTIONS[e]=actions[e].bind(a.tree,a.tree)}),a.rooted=baobabReact_higherOrder.root(a.tree,BranchedSchemaType),a}return inherits(t,e),t.prototype.componentWillReceiveProps=function(e){this.updateTree(e.value,e.schema)},t.prototype.shouldComponentUpdate=function(){return!1},t.prototype.componentWillUnmount=function(){this.tree.release()},t.prototype.getValue=function(){return this.tree.get("value")},t.prototype.updateTree=function(e,t){var n=this;this.tree.select("value").release(),this.tree.select("value").set(e),this.tree.select("schema").set(t),this.tree.select("status").release(),this.tree.commit(),this.tree.select("value").on("update",function(e){return n.props.onChange(e.data.currentData,validate(e.data.currentData,n.tree.get("schema"),e.data.currentData).errors)})},t.prototype.validate=function(){var e=validate(this.tree.get("value"),this.tree.get("schema"),this.tree.get("value")),t=this.ACTIONS.setErrors,n=new Map;return e.errors.forEach(function(e){var t=n.get(e.property)||[];t.push(e.message),n.set(e.property,t)}),n.forEach(function(e,n){t(n.split(/\.|\[|\]/).filter(function(e){return""!==e}).slice(1),e)}),e.errors},t.prototype.render=function(){var e=this.rooted;return React__default.createElement(e,{onChange:this.props.onChange,path:[],actions:this.ACTIONS})},t}(React__default.Component);Container$1.defaultProps={schema:{}},Container$1.setDefaultWidgets=setDefaultWidgets,module.exports=Container$1;
//# sourceMappingURL=index.js.map
