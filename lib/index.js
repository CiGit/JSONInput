"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t=require("react"),r=e(require("immer")),n=require("jsonschema"),o=require("lodash-es"),a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},u=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e},s=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},c=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},p=t.createContext({value:void 0,schema:{},status:{}}),l=p.Consumer,h=function(e){function n(){u(this,n);var t=c(this,e.apply(this,arguments));return t.state={schema:{},value:{},status:{},oldProps:{}},t.dispatch=function(e){for(var n=arguments.length,o=Array(n>1?n-1:0),a=1;a<n;a++)o[a-1]=arguments[a];t.setState(function(t){return r(e).apply(void 0,[t].concat(o))})},t}return s(n,e),n.getDerivedStateFromProps=function(e,t){if(t.oldProps!==e){var r={value:e.value,schema:e.schema,oldProps:e};return e.value!==t.value&&(r.status={}),r}return null},n.prototype.shouldComponentUpdate=function(e,t){return this.state!==t},n.prototype.componentDidUpdate=function(e,t){this.state.value!==t.value&&this.props.value===e.value&&this.props.onValueChange(this.state.value)},n.prototype.render=function(){var e=this.state,r=e.schema,n=e.value,o=e.status;return t.createElement(p.Provider,{value:this.state},this.props.children({schema:r,value:n,status:o,dispatch:this.dispatch}))},n}(t.Component);function f(e){return function(){return t.createElement("span",null,"Widget for '"+e+"' was not defined")}}var v={};function d(e){return v[e]||f(e)}function y(e){v=Object.assign({},v,e)}var m={};function g(e){var r=e.value,n=e.schema,o=e.schema.view,a={value:r,schema:n,children:e.children,editKey:e.editKey,path:e.path,onChange:e.onChange,onChildAdd:e.onChildAdd,onChildRemove:e.onChildRemove,addKey:e.addKey,removeKey:e.removeKey,alterKey:e.alterKey,errorMessage:e.errorMessage};if(o){var u=o.type;if("string"==typeof u){var s=d(u);return t.createElement(s,i({},a,{view:o}))}if("function"==typeof u){var c=u;return t.createElement(c,i({},a,{view:o}))}}var p=Array.isArray(n.type)?n.type.find(function(e){return"null"!==e}):n.type,l=void 0;return l=d(void 0===p?"undefinedType":p),t.createElement(l,i({},a,{view:o||m}))}var b=new n.Validator;function C(e,t,r){return b.validate(e,t,{formValue:r||{}})}b.attributes.errored=function(e,t,r){if("function"!=typeof t.errored)throw new n.SchemaError('"errored" expects a function');var o=t.errored(e,r.formValue);if(o)return o};var E="value",w="status",P="$$$state",j="$$$errors",K=[];function S(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments[2],n=[w].concat(t).concat([j]);o.set(e,n,r)}function O(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments[2],n=new Map;r.forEach(function(e){var t=n.get(e.property)||[];t.push(e.message),n.set(e.property,t)}),S(e,t,K),n.forEach(function(r,n){S(e,t.concat(n.split(/\.|\[|\]/).filter(function(e){return""!==e}).slice(1)),r)})}function _(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments[2],n=arguments[3],a=[w].concat(t);o.set(e,[E].concat(t),r),o.set(e,a.concat([P]),"dirty"),O(e,t,n)}function A(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];_(e,t,arguments[2],[]),o.set(e,[w].concat(t).concat([P]),"pristine")}function x(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];try{o.unset(e,[w].concat(t))}catch(e){}}function D(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return o.get(e,[w].concat(t).concat([j]))||K}function $(e){var r=function(r){function n(){u(this,n);var e=c(this,r.apply(this,arguments));return e.onChange=function(t){var r=C(t,e.props.schema,e.props.__tree.value);e.props.onChange(t,r.errors)},e}return s(n,r),n.prototype.shouldComponentUpdate=function(e){return this.props.value!==e.value||this.props.schema!==e.schema||D(this.props.__tree,this.props.path)!==D(e.__tree,e.path)},n.prototype.render=function(){var r=this.props.path;return t.createElement(e,i({},this.props,{errorMessage:D(this.props.__tree,r),onChange:this.onChange}))},n}(t.Component);return function(e){return t.createElement(l,null,function(n){return t.createElement(r,i({},e,{__tree:n}))})}}function V(e,t){var r=e.properties,n=void 0===r?{}:r;if(t in n)return n[t]}function k(e,t){var r=e.patternProperties||{},n=Object.keys(r).find(function(e){return new RegExp(e).test(t)});if(n)return r[n]}function M(e,t){return V(e,t)||k(e,t)||e.additionalProperties}var N={};function U(e){var r=[],n=e.schema.properties||{},o=e.value||{},a=Object.keys(n);function u(e){if(n[e]){var t=n[e].index;if("number"==typeof t)return t}return 0}Object.keys(o).forEach(function(e){e in n||a.push(e)}),a.sort(function(e,t){return u(e)-u(t)});for(var s=0;s<a.length;s+=1){var c=a[s],p=M(e.schema,c);r.push(t.createElement(se,i({},e,{status:e.status[c]||N,schema:p,value:o[c],editKey:c,key:s})))}return r}function R(e){return t.createElement(g,i({},e,{addKey:function(t,r){var n;if("object"===a(e.value)&&t in e.value)throw new Error('Property "'+t+'" already exists');e.onChange(Object.assign({},e.value,((n={})[t]=r,n)))},removeKey:function(t){var r=Object.assign({},e.value);delete r[t],e.onChange(r)},alterKey:function(t,r){if(t!==r){if(r in e.value)throw new Error('Property "'+r+'" already exists');var n={};Object.keys(e.value).forEach(function(o){o!==t?n[o]=e.value[o]:n[r]=e.value[o]}),e.onChange(n)}}}),U(e))}var q=$(R);function F(e){return t.createElement(g,e)}var T=$(F);function W(e){switch(void 0===e?"undefined":a(e)){case"number":return e;case"string":return""===e?void 0:Number(e);default:return}}var z=function(e){function r(){u(this,r);var t=c(this,e.apply(this,arguments));return t.state={value:t.props.value},t.onChange=function(e){var r=""===e?void 0:e,n=Number(r);t.setState({value:r},function(){return t.props.onChange(isNaN(n)?r:n)})},t}return s(r,e),r.prototype.render=function(){return t.createElement(F,i({},this.props,{value:this.state.value,onChange:this.onChange}))},r}(t.Component);z.getDerivedStateFromProps=function(e,t){return W(t.value)!==W(e.value)?{value:e.value}:null};var B=$(z);function G(e){return t.createElement(g,e)}var H=$(G),I={};function J(e){return function(t){var r=e.value||[];e.onChange(r.filter(function(e,r){return Number(r)!==Number(t)}))}}function L(e){return function(t){var r=e.value||[];e.onChange(r.concat([t]))}}function Q(e){var r=e.value,n=e.schema.items,o=[];return(r||[]).forEach(function(r,a){return o.push(t.createElement(se,i({},e,{schema:Array.isArray(n)?n[a]||{}:n,value:r,editKey:String(a),status:e.status[String(a)]||I,key:a})))}),o}function X(e){return t.createElement(g,i({},e,{onChildAdd:L(e),onChildRemove:J(e)}),Q(e))}var Y=$(X),Z={object:q,string:T,number:B,boolean:H,array:Y};function ee(e){return function(r){var n=r.schema.visible,o=r.value;return t.createElement(l,null,function(a){var u=a.value;try{if(n&&!n(o,u,r.path.concat()))return null}catch(e){return null}return t.createElement(e,r)})}}function te(e){return t.createElement("div",null,'Undefined field type "'+e.schema.type.toString()+'", ['+e.path.toString()+"]")}function re(e){switch(void 0===e?"undefined":a(e)){case"number":return"number";case"string":return"string";case"boolean":return"boolean";case"object":return Array.isArray(e)?"array":"object";default:return"string"}}function ne(e,t){return void 0!==t?e.concat([t]):e}function oe(e){return function(r){function n(){u(this,n);var e=c(this,r.apply(this,arguments));return e.state={path:[],schema:{},oldPath:null,oldEditKey:null},e}return s(n,r),n.getDerivedStateFromProps=function(e,t){var r={};if(t.oldEditKey===e.editKey&&t.oldPath===e.path||(r.path=ne(e.path,e.editKey),r.oldPath=e.path,r.oldEditKey=e.editKey),t.schema!==e.schema||re(e.value)!==re(t.oldValue)){var n=e.schema||{};"type"in n||(n=i({type:re(e.value)},n)),r.schema=n}return r},n.prototype.render=function(){return t.createElement(e,i({},this.props,{path:this.state.path,schema:this.state.schema}))},n}(t.Component)}function ae(e){var t=e.value,r=e.schema.value,n=e.dispatch,a=e.path,u=void 0!==t?t:o.cloneDeep(r);return u!==t&&n(A,a,u),u}function ue(e){return function(r){function n(){u(this,n);var e=c(this,r.apply(this,arguments));return e.state={val:e.props.value},e}return s(n,r),n.getDerivedStateFromProps=function(e){return void 0!==e.status.$$$state?null:{val:e.value}},n.prototype.componentDidMount=function(){var e=ae(this.props);e!==this.state.val&&this.setState({val:e})},n.prototype.componentDidUpdate=function(){var e=ae(this.props);e!==this.state.val&&this.setState({val:e})},n.prototype.render=function(){return t.createElement(e,i({},this.props,{value:this.state.val}))},n}(t.Component)}var ie=function(e){function r(t){u(this,r);var n=c(this,e.call(this,t));return n.onChange=n.onChange.bind(n),n}return s(r,e),r.prototype.onChange=function(){for(var e,t=arguments.length,r=Array(t),n=0;n<t;n++)r[n]=arguments[n];(e=this.props).dispatch.apply(e,[_,this.props.path].concat(r))},r.prototype.componentWillUnmount=function(){this.props.dispatch(x,this.props.path)},r.prototype.render=function(){var e=this.props.schema.type,r=Array.isArray(e)?e.find(function(e){return"null"!==e}):e,n=void 0;return void 0===(n=void 0===r||"null"===r?te:Z[r])&&(n=te),t.createElement(n,i({},this.props,{onChange:this.onChange}))},r}(t.Component);ie.defaultProps={path:[]};var se=oe(ue(ee(ie))),ce=[],pe=function(e){function r(){u(this,r);var t=c(this,e.apply(this,arguments));return t.store=null,t}return s(r,e),r.prototype.getValue=function(){return this.store.state.value},r.prototype.validate=function(){var e=C(this.store.state.value,this.store.state.schema,this.store.state.value);return this.store.dispatch(O,[],e.errors),e.errors},r.prototype.render=function(){var e=this;return t.createElement(h,{ref:function(t){e.store=t},value:this.props.value,schema:this.props.schema,onValueChange:function(t){return e.props.onChange(t,C(t,e.props.schema,t).errors)}},function(e){var r=e.schema,n=e.value,o=e.status,a=e.dispatch;return t.createElement(se,{schema:r,dispatch:a,value:n,path:ce,status:o})})},r}(t.Component);pe.defaultProps={schema:{}},exports.default=pe,exports.setDefaultWidgets=y;
//# sourceMappingURL=index.js.map
