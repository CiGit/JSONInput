'use strict';Object.defineProperty(exports,'__esModule',{value:!0});function _interopDefault(a){return a&&'object'==typeof a&&'default'in a?a['default']:a}var React=_interopDefault(require('react')),baobabReact_higherOrder=require('baobab-react/higher-order'),Baobab=_interopDefault(require('baobab')),propTypes=_interopDefault(require('prop-types')),jsonschema=require('jsonschema'),jsonschema__default=_interopDefault(jsonschema),createTree=function(){return new Baobab({schema:{},value:{},status:{}})};function undefinedWidgetFactory(b){return function(){return React.createElement('span',null,'Widget for \''+b+'\' was not defined')}}function labeled(e){function a(a){var f=a.schema.required,c=f?'required':'';return React.createElement('div',null,React.createElement('label',{className:a.schema.type+'Field '+c},React.createElement('span',{className:'title'},a.view.title||a.editKey),React.createElement(e,a),React.createElement('span',null,a.view.description),React.createElement('span',null,a.errorMessage)))}return a.defaultProps={editKey:'',errorMessage:[]},a}function onInputChange(c){return function(a){'checkbox'===a.target.type?c(a.target.checked):c(a.target.value)}}function Input(b){return React.createElement('input',{type:b.type,placeholder:b.schema.placeholder,value:b.value||'',className:b.className,onChange:onInputChange(b.onChange),checked:b.checked})}Input.defaultProps={className:void 0,checked:!1};var _typeof='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&'function'==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?'symbol':typeof a},classCallCheck=function(a,b){if(!(a instanceof b))throw new TypeError('Cannot call a class as a function')},_extends=Object.assign||function(a){for(var b,c=1;c<arguments.length;c++)for(var d in b=arguments[c],b)Object.prototype.hasOwnProperty.call(b,d)&&(a[d]=b[d]);return a},inherits=function(a,b){if('function'!=typeof b&&null!==b)throw new TypeError('Super expression must either be null or a function, not '+typeof b);a.prototype=Object.create(b&&b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}}),b&&(Object.setPrototypeOf?Object.setPrototypeOf(a,b):a.__proto__=b)},possibleConstructorReturn=function(a,b){if(!a)throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called');return b&&('object'==typeof b||'function'==typeof b)?b:a};function TextWidget(b){return React.createElement(Input,_extends({},b,{type:'string'}))}var TextWidget$1=labeled(TextWidget);function ArrowNumberWidget(b){return React.createElement(Input,_extends({},b,{type:'number'}))}var ArrowNumberWidget$1=labeled(ArrowNumberWidget);function CheckboxWidget(b){return React.createElement(Input,_extends({},b,{type:'checkbox',checked:b.value}))}CheckboxWidget.defaultProps={value:!1};var CheckboxWidget$1=labeled(CheckboxWidget);function ArrayWidget(d){var a=React.Children.map(d.children,function(a,b){return React.createElement('div',null,React.createElement('button',{onClick:function(){d.onChildRemove(b)}},'-'),a)});return React.createElement('div',null,React.createElement('div',null,a),React.createElement('button',{onClick:d.onChildAdd},'+'))}var ArrayWidget$1=labeled(ArrayWidget);function ObjectWidget(b){return React.createElement('div',null,b.children)}var ObjectWidget$1=labeled(ObjectWidget);function SelectWidget(f){var a=f.view,b=f.value,g=f.onChange,d=a.choices.map(function(b){return React.createElement('option',{key:b.value,value:b.value},b.label)});return React.createElement('select',{value:b,onChange:function(b){return g(b.target.value)}},d)}var DefaultWidget={string:TextWidget$1,number:TextWidget$1,boolean:CheckboxWidget$1,array:ArrayWidget$1,object:ObjectWidget$1,arrowNumber:ArrowNumberWidget$1,select:SelectWidget};function defaultWidget(b){return DefaultWidget[b]||undefinedWidgetFactory(b)}function setDefaultWidgets(b){DefaultWidget=Object.assign({},DefaultWidget,b)}var EMPTYOBJECT={};function Widget(t){var a=t.value,u=t.schema,v=t.schema.view,w=t.children,x=t.editKey,y=t.path,z=t.onChange,A=t.onChildAdd,B=t.onChildRemove,C=t.addKey,D=t.removeKey,E=t.alterKey,F=t.errorMessage,G={value:a,schema:u,children:w,editKey:x,path:y,onChange:z,onChildAdd:A,onChildRemove:B,addKey:C,removeKey:D,alterKey:E,errorMessage:F};if(v){var o=v.type;if('string'==typeof o){var H=defaultWidget(o);return React.createElement(H,_extends({},G,{view:v}))}if('function'==typeof o)return React.createElement(o,_extends({},G,{view:v}))}var s,q=Array.isArray(u.type)?u.type.find(function(b){return'null'!==b}):u.type;return s=void 0===q?defaultWidget('undefinedType'):defaultWidget(q),React.createElement(s,_extends({},G,{view:v||EMPTYOBJECT}))}var customValidator=new jsonschema.Validator;customValidator.attributes.errored=function(e,a,b){if('function'!=typeof a.errored)throw new jsonschema__default.SchemaError('"errored" expects a function');var c=a.errored(e,b.formValue);return c?c:void 0};function validate(d,a,b){return customValidator.validate(d,a,{formValue:b})}var VALUE='value',STATUS='status',STATE='state',ERRORS='errors',NOERRORS=[];function setErrors(f,a,b){var c=[STATUS].concat(a).concat([ERRORS]),d=f.select(c);b&&b.length&&Array.isArray(d.get())?(d.splice([0,d.get().length]),d.concat(b||[])):d.set(b||NOERRORS)}function update(f,a,b,c){var d=[STATUS].concat(a);f.set([VALUE].concat(a),b),f.set(d.concat([STATE]),'dirty'),setErrors(f,a,c)}function setDefaultValue(d,a,b){d.set([VALUE].concat(a),b),d.set([STATUS].concat(a).concat([STATE]),'pristine')}function getErrors(c,a){return c.get([STATUS].concat(a).concat([ERRORS]))||NOERRORS}function getFormValue(b){return b.get(VALUE)}function schemaPath(d,a){return a.reduce(function(a,b){return'object'===d.get(a).type?a.concat(['properties',b]):'array'===d.get(a).type?a.concat(['items']):a.concat([b])},['schema'])}function updateSchema(e,a,b){var c=schemaPath(e,a);e.set(c,b)}function deleteSchema(d,a){var b=schemaPath(d,a);d.unset(b)}function validated$1(c){return function(e){return React.createElement(c,_extends({},e,{errorMessage:e.dispatch(getErrors,e.path),onChange:function(b){var a=validate(b,e.schema,e.dispatch(getFormValue)),c=a.errors.map(function(b){return b.message});e.onChange(b,c)}}))}}var EMPTY_OBJECT={};function renderChildren(j){function k(d){if(c[d]){var a=c[d].index;if('number'==typeof a)return a}return 0}var a=[],c=j.schema.properties||{},b=j.value||{},d=Object.keys(c);Object.keys(b).forEach(function(b){b in c||d.push(b)}),d.sort(function(b,c){return k(b)-k(c)});for(var e,f=0;f<d.length;f+=1)if(e=d[f],e in c)a.push(React.createElement(SchemaType$1,_extends({},j,{status:j.status[e]||EMPTY_OBJECT,schema:c[e],value:b[e],editKey:e,key:e})));else{var h=j.schema.additionalProperties;h&&j.dispatch(updateSchema,j.path.concat([e]),h),a.push(React.createElement(SchemaType$1,_extends({},j,{status:j.status[e]||EMPTY_OBJECT,schema:h,value:b[e],editKey:e,key:e})))}return a}function ObjectField(f){return React.createElement(Widget,_extends({},f,{addKey:function(a,b){var c;f.onChange(Object.assign({},f.value,(c={},c[a]=b,c)))},removeKey:function(a){var b=Object.assign({},f.value);delete b[a],f.schema.properties&&a in f.schema.properties||f.dispatch(deleteSchema,f.path.concat([a]),{}),f.onChange(b)},alterKey:function(a,b){var c={};Object.keys(f.value).forEach(function(d){d===a?c[b]=f.value[d]:c[d]=f.value[d]}),f.onChange(c)}}),renderChildren(f))}var ObjectField$1=validated$1(ObjectField);function StringField(c){var a=void 0!==c.value&&null!==c.value?c.value+'':c.value;return React.createElement(Widget,_extends({},c,{value:a}))}var StringField$1=validated$1(StringField),NumberField=function(e){function a(b){classCallCheck(this,a);var c=possibleConstructorReturn(this,e.call(this,b));return c.state={value:b.value},c.boundChange=c.onChange.bind(c),c}return inherits(a,e),a.prototype.componentWillReceiveProps=function(b){+this.state.value!=+b.value&&this.setState({value:b.value})},a.prototype.onChange=function(e){var a=this,b=''===e?void 0:e,f=+b;this.setState({value:b},function(){return a.props.onChange(isNaN(f)?b:f)})},a.prototype.render=function(){return React.createElement(StringField,_extends({},this.props,{value:this.state.value,onChange:this.boundChange}))},a}(React.Component),NumberField$1=validated$1(NumberField);function BooleanField(b){return React.createElement(Widget,b)}var BooleanField$1=validated$1(BooleanField),EMPTY_OBJECT$1={};function onChildChange(e,f){return function(g){var b=f.value;b?f.onChange(b.map(function(c,b){return+b==+e?g:c})):f.onChange([g])}}function onChildRemove(d){return function(e){var a=d.value||[];d.onChange(a.filter(function(d,a){return+a!=+e}))}}function onChildAdd(c){return function(){var a=c.value||[];c.onChange(a.concat([void 0]))}}function renderChildren$1(h){var a,f=h.value,b=h.schema,c=b.value,d=b.items;a=f?f:c?c:[];var e=[];return a.forEach(function(a,f){return e.push(React.createElement(SchemaType$1,_extends({},h,{schema:Array.isArray(d)?d[f]||{}:d,value:a,editKey:f+'',status:h.status[f+'']||EMPTY_OBJECT$1,key:f,onChange:onChildChange(f,h)})))}),e}function ArrayField(b){return React.createElement(Widget,_extends({},b,{onChildAdd:onChildAdd(b),onChildRemove:onChildRemove(b)}),renderChildren$1(b))}var ArrayField$1=validated$1(ArrayField),Fields={object:ObjectField$1,string:StringField$1,number:NumberField$1,boolean:BooleanField$1,array:ArrayField$1};function visibility$1(e){return function(a){var b=a.schema.visible,c=a.value;try{if(b&&!b(c,a.dispatch(getFormValue),a.path))return null}catch(b){return null}return React.createElement(e,a)}}function Undefined(b){return React.createElement('span',null,'Undefined field type "'+b.schema.type.toString()+'", ['+b.path.toString()+']')}function infer(b){switch('undefined'==typeof b?'undefined':_typeof(b)){case'number':return'number';case'string':return'string';case'boolean':return'boolean';case'object':return Array.isArray(b)?'array':'object';default:return'string';}}function updatePath(c,a){return a?c.concat([a]):c}function inference(c){var a=function(g){function b(c){classCallCheck(this,b);var a=possibleConstructorReturn(this,g.call(this,c)),d=c.schema,e=d;return e&&'type'in e||(e={type:infer(c.value)}),a.state={schema:e},a.path=updatePath(a.props.path,a.props.editKey),a}return inherits(b,g),b.prototype.componentWillReceiveProps=function(c){if(this.props.schema!==c.schema){var a=c.schema;a&&'type'in a||(a={type:infer(c.value)}),this.setState(function(){return{schema:a}})}},b.prototype.render=function(){return React.createElement(c,_extends({},this.props,{path:this.path,schema:this.state.schema}))},b}(React.Component);return a}function updateDefault(e){var a=e.value,b=e.schema.value,c=void 0===a?b:a;return c}function fromDefaultValue(c){var a=function(e){function b(c){classCallCheck(this,b);var a=possibleConstructorReturn(this,e.call(this,c));return a.state={val:updateDefault(c)},a.notifyDefaultChange(),a}return inherits(b,e),b.prototype.componentDidMount=function(){},b.prototype.componentWillReceiveProps=function(b){b.schema===this.props.schema?this.setState({val:b.value}):this.setState({val:updateDefault(b)})},b.prototype.componentDidUpdate=function(){this.notifyDefaultChange()},b.prototype.notifyDefaultChange=function(){this.props.value!==this.state.val&&this.props.dispatch(setDefaultValue,this.props.path,this.state.val)},b.prototype.render=function(){return React.createElement(c,_extends({},this.props,{value:this.state.val}))},b}(React.Component);return a}var SchemaType=function(e){function a(f){classCallCheck(this,a);var b=possibleConstructorReturn(this,e.call(this,f));return b.onChange=function(){for(var c=arguments.length,a=Array(c),b=0;b<c;b++)a[b]=arguments[b];f.dispatch.apply(f,[update,f.path].concat(a))},b}return inherits(a,e),a.prototype.render=function(){var d,c=this.props.schema.type,a=Array.isArray(c)?c.find(function(b){return'null'!==b}):c;return d=void 0===a||'null'===a?Undefined:Fields[a],React.createElement(d,_extends({},this.props,{onChange:this.onChange}))},a}(React.Component);SchemaType.defaultProps={path:[]};var SchemaType$1=inference(fromDefaultValue(visibility$1(SchemaType))),BranchedSchemaType=baobabReact_higherOrder.branch({schema:'schema',status:'status',value:'value'},SchemaType$1);function noop(){}var Container$1=function(e){function a(b){classCallCheck(this,a);var c=possibleConstructorReturn(this,e.call(this,b));return c.tree=createTree(),c.updateTree(b.value,b.schema),c.rooted=baobabReact_higherOrder.root(c.tree,BranchedSchemaType),c}return inherits(a,e),a.prototype.componentDidMount=function(){var c=this;this.tree.select('value').on('update',function(a){c.event&&c.props.onChange(a.data.currentData,validate(a.data.currentData,c.tree.get('schema'),a.data.currentData).errors)})},a.prototype.componentWillReceiveProps=function(b){b.value===this.tree.get('value')&&b.schema===this.props.schema||this.updateTree(b.value,b.schema)},a.prototype.componentWillUnmount=function(){this.tree.release()},a.prototype.shouldComponentUpdate=function(){return!1},a.prototype.getValue=function(){return this.tree.get('value')},a.prototype.updateTree=function(c,a){this.event=!1,this.tree.set('value',c),this.tree.set('schema',a),this.tree.set('status',{}),this.tree.commit(),this.event=!0},a.prototype.validate=function(){var d=this,a=validate(this.tree.get('value'),this.tree.get('schema'),this.tree.get('value')),e=new Map;return a.errors.forEach(function(c){var a=e.get(c.property)||[];a.push(c.message),e.set(c.property,a)}),e.forEach(function(a,b){setErrors(d.tree,b.split(/\.|\[|\]/).filter(function(b){return''!==b}).slice(1),a)}),a.errors},a.prototype.render=function(){var b=this.rooted;return React.createElement(b,{onChange:noop,path:[]})},a}(React.Component);Container$1.defaultProps={schema:{}},exports['default']=Container$1,exports.setDefaultWidgets=setDefaultWidgets;
//# sourceMappingURL=index.js.map
