"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t=e(require("baobab")),n=require("react"),r=require("jsonschema"),o=require("baobab-react/higher-order"),a=function(){return new t({schema:{},value:{},status:{}})};function i(e){return function(){return n.createElement("span",null,"Widget for '"+e+"' was not defined")}}var u={};function c(e){return u[e]||i(e)}function s(e){u=Object.assign({},u,e)}var l="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},h=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},p=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e},f=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},v=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},d={};function y(e){var t=e.value,r=e.schema,o=e.schema.view,a={value:t,schema:r,children:e.children,editKey:e.editKey,path:e.path,onChange:e.onChange,onChildAdd:e.onChildAdd,onChildRemove:e.onChildRemove,addKey:e.addKey,removeKey:e.removeKey,alterKey:e.alterKey,errorMessage:e.errorMessage};if(o){var i=o.type;if("string"==typeof i){var u=c(i);return n.createElement(u,p({},a,{view:o}))}if("function"==typeof i){var s=i;return n.createElement(s,p({},a,{view:o}))}}var l=Array.isArray(r.type)?r.type.find(function(e){return"null"!==e}):r.type,h=void 0;return h=c(void 0===l?"undefinedType":l),n.createElement(h,p({},a,{view:o||d}))}var m=new r.Validator;function g(e,t,n){return m.validate(e,t,{formValue:n})}m.attributes.errored=function(e,t,n){if("function"!=typeof t.errored)throw new r.SchemaError('"errored" expects a function');var o=t.errored(e,n.formValue);if(o)return o};var b="value",C="status",E="$$$state",w="$$$errors",j=[];function K(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments[2],r=[C].concat(t).concat([w]),o=e.select(r);n&&n.length&&Array.isArray(o.get())?(o.splice([0,o.get().length]),o.concat(n||[])):o.set(n||j)}function S(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments[2],r=new Map;n.forEach(function(e){var t=r.get(e.property)||[];t.push(e.message),r.set(e.property,t)}),K(e,t,j),r.forEach(function(n,r){K(e,t.concat(r.split(/\.|\[|\]/).filter(function(e){return""!==e}).slice(1)),n)})}function O(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments[2],r=arguments[3],o=[C].concat(t);e.set([b].concat(t),n),e.set(o.concat([E]),"dirty"),S(e,t,r)}function P(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];O(e,t,arguments[2],[]),e.set([C].concat(t).concat([E]),"pristine")}function A(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];try{e.unset([C].concat(t)),e.unset([b].concat(t))}catch(e){}}function x(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return e.get([C].concat(t).concat([w]))||j}function D(e){return e.get(b)}function $(e){return function(t){return n.createElement(e,p({},t,{errorMessage:t.dispatch(x,t.path),onChange:function(e){var n=g(e,t.schema,t.dispatch(D));t.onChange(e,n.errors)}}))}}function k(e,t){var n=e.properties,r=void 0===n?{}:n;if(t in r)return r[t]}function M(e,t){var n=e.patternProperties||{},r=Object.keys(n).find(function(e){return new RegExp(e).test(t)});if(r)return n[r]}function N(e,t){return k(e,t)||M(e,t)||e.additionalProperties}var T={};function _(e){var t=[],r=e.schema.properties||{},o=e.value||{},a=Object.keys(r);function i(e){if(r[e]){var t=r[e].index;if("number"==typeof t)return t}return 0}Object.keys(o).forEach(function(e){e in r||a.push(e)}),a.sort(function(e,t){return i(e)-i(t)});for(var u=0;u<a.length;u+=1){var c=a[u],s=N(e.schema,c);t.push(n.createElement(ce,p({},e,{status:e.status[c]||T,schema:s,value:o[c],editKey:c,key:u})))}return t}function R(e){return n.createElement(y,p({},e,{addKey:function(t,n){var r;if("object"===l(e.value)&&t in e.value)throw new Error('Property "'+t+'" already exists');e.onChange(Object.assign({},e.value,((r={})[t]=n,r)))},removeKey:function(t){var n=Object.assign({},e.value);delete n[t],e.onChange(n)},alterKey:function(t,n){if(t!==n){if(n in e.value)throw new Error('Property "'+n+'" already exists');var r={};Object.keys(e.value).forEach(function(o){o!==t?r[o]=e.value[o]:r[n]=e.value[o]}),e.onChange(r)}}}),_(e))}var q=$(R);function U(e){return n.createElement(y,e)}var V=$(U);function W(e){switch(void 0===e?"undefined":l(e)){case"number":return e;case"string":return""===e?void 0:Number(e);default:return}}var F=function(e){function t(){h(this,t);var n=v(this,e.apply(this,arguments));return n.state={value:n.props.value},n.onChange=function(e){var t=""===e?void 0:e,r=Number(t);n.setState({value:t},function(){return n.props.onChange(isNaN(r)?t:r)})},n}return f(t,e),t.prototype.render=function(){return n.createElement(U,p({},this.props,{value:this.state.value,onChange:this.onChange}))},t}(n.Component);F.getDerivedStateFromProps=function(e,t){return W(t.value)!==W(e.value)?{value:e.value}:null};var z=$(F);function B(e){return n.createElement(y,e)}var G=$(B),H={};function I(e,t){return function(n){var r=t.value;r?t.onChange(r.map(function(t,r){return+r!=+e?t:n})):t.onChange([n])}}function J(e){return function(t){var n=e.value||[];e.onChange(n.filter(function(e,n){return Number(n)!==Number(t)}))}}function L(e){return function(t){var n=e.value||[];e.onChange(n.concat([t]))}}function Q(e){var t=e.value,r=e.schema,o=r.value,a=r.items,i=[];return(t||(o||[])).forEach(function(t,r){return i.push(n.createElement(ce,p({},e,{schema:Array.isArray(a)?a[r]||{}:a,value:t,editKey:String(r),status:e.status[String(r)]||H,key:r,onChange:I(r,e)})))}),i}function X(e){return n.createElement(y,p({},e,{onChildAdd:L(e),onChildRemove:J(e)}),Q(e))}var Y=$(X),Z={object:q,string:V,number:z,boolean:G,array:Y};function ee(e){return function(t){var r=t.schema.visible,o=t.value;try{if(r&&!r(o,t.dispatch(D),t.path.concat()))return null}catch(e){return null}return n.createElement(e,t)}}function te(e){return n.createElement("div",null,'Undefined field type "'+e.schema.type.toString()+'", ['+e.path.toString()+"]")}function ne(e){switch(void 0===e?"undefined":l(e)){case"number":return"number";case"string":return"string";case"boolean":return"boolean";case"object":return Array.isArray(e)?"array":"object";default:return"string"}}function re(e,t){return void 0!==t?e.concat([t]):e}function oe(e){return function(t){function r(){h(this,r);var e=v(this,t.apply(this,arguments));return e.state={path:[],schema:{},oldPath:null,oldEditKey:null,oldSchema:null},e}return f(r,t),r.getDerivedStateFromProps=function(e,t){var n={};if(t.oldEditKey===e.editKey&&t.oldPath===e.path||(n.path=re(e.path,e.editKey),n.oldPath=e.path,n.oldEditKey=e.editKey),t.oldSchema!==e.schema){var r=e.schema||{};"type"in r||(r=p({type:ne(e.value)},r)),n.schema=r,n.oldSchema=e.schema}return n},r.prototype.render=function(){return n.createElement(e,p({},this.props,{path:this.state.path,schema:this.state.schema}))},r}(n.Component)}function ae(e){var t=e.value,n=e.schema.value,r=e.dispatch,o=e.path,a=void 0!==t?t:n;return r(P,o,a),a}function ie(e){return function(t){function r(){h(this,r);var e=v(this,t.apply(this,arguments));return e.state={val:void 0},e}return f(r,t),r.getDerivedStateFromProps=function(e){return void 0===e.status.$$$state?{val:ae(e)}:{val:e.value}},r.prototype.render=function(){return n.createElement(e,p({},this.props,{value:this.state.val}))},r}(n.Component)}var ue=function(e){function t(n){h(this,t);var r=v(this,e.call(this,n));return r.onChange=r.onChange.bind(r),r}return f(t,e),t.prototype.onChange=function(){for(var e,t=arguments.length,n=Array(t),r=0;r<t;r++)n[r]=arguments[r];(e=this.props).dispatch.apply(e,[O,this.props.path].concat(n))},t.prototype.componentWillUnmount=function(){this.props.dispatch(A,this.props.path)},t.prototype.render=function(){var e=this.props.schema.type,t=Array.isArray(e)?e.find(function(e){return"null"!==e}):e,r=void 0;return void 0===(r=void 0===t||"null"===t?te:Z[t])&&(r=te),n.createElement(r,p({},this.props,{onChange:this.onChange}))},t}(n.Component);ue.defaultProps={path:[]};var ce=oe(ie(ee(ue))),se=[],le=o.branch({schema:"schema",status:"status",value:"value"},ce);function he(){}var pe=function(e){function t(n){h(this,t);var r=v(this,e.call(this,n));return r.event=!1,r.tree=a(),r.updateTree(n.value,n.schema),r.rooted=o.root(r.tree,le),r}return f(t,e),t.prototype.componentDidMount=function(){var e=this;this.tree.select("value").on("update",function(t){e.event&&e.props.onChange(t.data.currentData,g(t.data.currentData,e.tree.get("schema"),t.data.currentData).errors)})},t.prototype.componentDidUpdate=function(e){this.props.value===this.tree.get("value")&&this.props.schema===e.schema||this.updateTree(this.props.value,this.props.schema)},t.prototype.componentWillUnmount=function(){this.tree.release()},t.prototype.getValue=function(){return this.tree.get("value")},t.prototype.updateTree=function(e,t){this.event=!1,this.tree.set({value:e,schema:t,status:{}}),this.tree.commit(),this.event=!0},t.prototype.validate=function(){var e=g(this.tree.get("value"),this.tree.get("schema"),this.tree.get("value"));return S(this.tree,[],e.errors),e.errors},t.prototype.render=function(){var e=this.rooted;return n.createElement(e,{onChange:he,path:se})},t}(n.Component);pe.defaultProps={schema:{}},exports.default=pe,exports.setDefaultWidgets=s;
//# sourceMappingURL=index.js.map
