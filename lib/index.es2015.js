import{createElement as t,Component as e,createContext as n}from"react";import r from"immer";import{Validator as o,SchemaError as a}from"jsonschema";import{set as i,get as u,unset as s}from"lodash-es";var c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},h=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},l=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t},p=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},f=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},v=n({value:void 0,schema:{},status:{}}),d=v.Consumer,y=function(e){function n(){h(this,n);var t=f(this,e.apply(this,arguments));return t.state={schema:{},value:{},status:{}},t.dispatch=function(e){for(var n=arguments.length,o=Array(n>1?n-1:0),a=1;a<n;a++)o[a-1]=arguments[a];t.setState(function(t){return r(e).apply(void 0,[t].concat(o))})},t}return p(n,e),n.getDerivedStateFromProps=function(t,e){return e.schema!==t.schema||e.value!==t.value?{value:t.value,schema:t.schema,status:{}}:null},n.prototype.shouldComponentUpdate=function(t,e){return this.state!==e},n.prototype.componentDidUpdate=function(t,e){this.state.value!==e.value&&this.props.onValueChange(this.state.value)},n.prototype.render=function(){return t(v.Provider,{value:this.state},this.props.children(l({},this.state,{dispatch:this.dispatch})))},n}(e);function m(e){return function(){return t("span",null,"Widget for '"+e+"' was not defined")}}var g={};function b(t){return g[t]||m(t)}function C(t){g=Object.assign({},g,t)}var w={};function K(e){var n=e.value,r=e.schema,o=e.schema.view,a={value:n,schema:r,children:e.children,editKey:e.editKey,path:e.path,onChange:e.onChange,onChildAdd:e.onChildAdd,onChildRemove:e.onChildRemove,addKey:e.addKey,removeKey:e.removeKey,alterKey:e.alterKey,errorMessage:e.errorMessage};if(o){var i=o.type;if("string"==typeof i){var u=b(i);return t(u,l({},a,{view:o}))}if("function"==typeof i)return t(i,l({},a,{view:o}))}var s=Array.isArray(r.type)?r.type.find(function(t){return"null"!==t}):r.type,c=void 0;return c=b(void 0===s?"undefinedType":s),t(c,l({},a,{view:o||w}))}var S=new o;function j(t,e,n){return S.validate(t,e,{formValue:n||{}})}S.attributes.errored=function(t,e,n){if("function"!=typeof e.errored)throw new a('"errored" expects a function');var r=e.errored(t,n.formValue);if(r)return r};var P="value",O="status",E="$$$state",A="$$$errors",$=[];function x(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments[2],r=[O].concat(e).concat([A]);i(t,r,n)}function k(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments[2],r=new Map;n.forEach(function(t){var e=r.get(t.property)||[];e.push(t.message),r.set(t.property,e)}),x(t,e,$),r.forEach(function(n,r){x(t,e.concat(r.split(/\.|\[|\]/).filter(function(t){return""!==t}).slice(1)),n)})}function N(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments[2],r=arguments[3],o=[O].concat(e);i(t,[P].concat(e),n),i(t,o.concat([E]),"dirty"),k(t,e,r)}function D(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];N(t,e,arguments[2],[]),i(t,[O].concat(e).concat([E]),"pristine")}function R(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];try{s(t,[O].concat(e))}catch(t){}}function V(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return u(t,[O].concat(e).concat([A]))||$}function F(e){return function(n){return t(d,null,function(r){return t(e,l({},n,{errorMessage:V(r,n.path),onChange:function(t){var e=j(t,n.schema,r.value);n.onChange(t,e.errors)}}))})}}function M(t,e){var n=t.properties,r=void 0===n?{}:n;if(e in r)return r[e]}function U(t,e){var n=t.patternProperties||{},r=Object.keys(n).find(function(t){return new RegExp(t).test(e)});if(r)return n[r]}function _(t,e){return M(t,e)||U(t,e)||t.additionalProperties}var T={};function W(e){var n=[],r=e.schema.properties||{},o=e.value||{},a=Object.keys(r);function i(t){if(r[t]){var e=r[t].index;if("number"==typeof e)return e}return 0}Object.keys(o).forEach(function(t){t in r||a.push(t)}),a.sort(function(t,e){return i(t)-i(e)});for(var u=0;u<a.length;u+=1){var s=a[u],c=_(e.schema,s);n.push(t(ft,l({},e,{status:e.status[s]||T,schema:c,value:o[s],editKey:s,key:u})))}return n}function q(e){return t(K,l({},e,{addKey:function(t,n){var r;if("object"===c(e.value)&&t in e.value)throw new Error('Property "'+t+'" already exists');e.onChange(Object.assign({},e.value,((r={})[t]=n,r)))},removeKey:function(t){var n=Object.assign({},e.value);delete n[t],e.onChange(n)},alterKey:function(t,n){if(t!==n){if(n in e.value)throw new Error('Property "'+n+'" already exists');var r={};Object.keys(e.value).forEach(function(o){o!==t?r[o]=e.value[o]:r[n]=e.value[o]}),e.onChange(r)}}}),W(e))}var z=F(q);function B(e){return t(K,e)}var G=F(B);function H(t){switch(void 0===t?"undefined":c(t)){case"number":return t;case"string":return""===t?void 0:Number(t);default:return}}var I=function(e){function n(){h(this,n);var t=f(this,e.apply(this,arguments));return t.state={value:t.props.value},t.onChange=function(e){var n=""===e?void 0:e,r=Number(n);t.setState({value:n},function(){return t.props.onChange(isNaN(r)?n:r)})},t}return p(n,e),n.prototype.render=function(){return t(B,l({},this.props,{value:this.state.value,onChange:this.onChange}))},n}(e);I.getDerivedStateFromProps=function(t,e){return H(e.value)!==H(t.value)?{value:t.value}:null};var J=F(I);function L(e){return t(K,e)}var Q=F(L),X={};function Y(t,e){return function(n){var r=e.value;r?e.onChange(r.map(function(e,r){return+r!=+t?e:n})):e.onChange([n])}}function Z(t){return function(e){var n=t.value||[];t.onChange(n.filter(function(t,n){return Number(n)!==Number(e)}))}}function tt(t){return function(e){var n=t.value||[];t.onChange(n.concat([e]))}}function et(e){var n=e.value,r=e.schema,o=r.value,a=r.items,i=[];return(n||(o||[])).forEach(function(n,r){return i.push(t(ft,l({},e,{schema:Array.isArray(a)?a[r]||{}:a,value:n,editKey:String(r),status:e.status[String(r)]||X,key:r,onChange:Y(r,e)})))}),i}function nt(e){return t(K,l({},e,{onChildAdd:tt(e),onChildRemove:Z(e)}),et(e))}var rt=F(nt),ot={object:z,string:G,number:J,boolean:Q,array:rt};function at(e){return function(n){var r=n.schema.visible,o=n.value;return t(d,null,function(a){var i=a.value;try{if(r&&!r(o,i,n.path.concat()))return null}catch(t){return null}return t(e,n)})}}function it(e){return t("div",null,'Undefined field type "'+e.schema.type.toString()+'", ['+e.path.toString()+"]")}function ut(t){switch(void 0===t?"undefined":c(t)){case"number":return"number";case"string":return"string";case"boolean":return"boolean";case"object":return Array.isArray(t)?"array":"object";default:return"string"}}function st(t,e){return void 0!==e?t.concat([e]):t}function ct(n){return function(e){function r(){h(this,r);var t=f(this,e.apply(this,arguments));return t.state={path:[],schema:{},oldPath:null,oldEditKey:null,oldSchema:null},t}return p(r,e),r.getDerivedStateFromProps=function(t,e){var n={};if(e.oldEditKey===t.editKey&&e.oldPath===t.path||(n.path=st(t.path,t.editKey),n.oldPath=t.path,n.oldEditKey=t.editKey),e.oldSchema!==t.schema){var r=t.schema||{};"type"in r||(r=l({type:ut(t.value)},r)),n.schema=r,n.oldSchema=t.schema}return n},r.prototype.render=function(){return t(n,l({},this.props,{path:this.state.path,schema:this.state.schema}))},r}(e)}function ht(t){var e=t.value,n=t.schema.value,r=t.dispatch,o=t.path,a=void 0!==e?e:n;return a!==e&&r(D,o,a),a}function lt(n){return function(e){function r(){h(this,r);var t=f(this,e.apply(this,arguments));return t.state={val:void 0},t}return p(r,e),r.getDerivedStateFromProps=function(t){return void 0===t.status.$$$state?{val:ht(t)}:{val:t.value}},r.prototype.render=function(){return t(n,l({},this.props,{value:this.state.val}))},r}(e)}var pt=function(e){function n(t){h(this,n);var r=f(this,e.call(this,t));return r.onChange=r.onChange.bind(r),r}return p(n,e),n.prototype.onChange=function(){for(var t,e=arguments.length,n=Array(e),r=0;r<e;r++)n[r]=arguments[r];(t=this.props).dispatch.apply(t,[N,this.props.path].concat(n))},n.prototype.componentWillUnmount=function(){this.props.dispatch(R,this.props.path)},n.prototype.render=function(){var e=this.props.schema.type,n=Array.isArray(e)?e.find(function(t){return"null"!==t}):e,r=void 0;return void 0===(r=void 0===n||"null"===n?it:ot[n])&&(r=it),t(r,l({},this.props,{onChange:this.onChange}))},n}(e);pt.defaultProps={path:[]};var ft=ct(lt(at(pt))),vt=[];function dt(){}var yt=function(e){function n(){h(this,n);var t=f(this,e.apply(this,arguments));return t.store=null,t}return p(n,e),n.prototype.getValue=function(){return this.store.state.value},n.prototype.validate=function(){var t=j(this.store.state.value,this.store.state.schema,this.store.state.value);return this.store.dispatch(k,[],t.errors),t.errors},n.prototype.render=function(){var e=this;return t(y,{ref:function(t){e.store=t},value:this.props.value,schema:this.props.schema,onValueChange:function(t){return e.props.onChange(t,j(t,e.props.schema,t).errors)}},function(e){var n=e.schema,r=e.value,o=e.status,a=e.dispatch;return t(ft,{schema:n,dispatch:a,value:r,path:vt,onChange:dt,status:o})})},n}(e);yt.defaultProps={schema:{}};export default yt;export{C as setDefaultWidgets};
//# sourceMappingURL=index.es2015.js.map
