import React from'react';import{branch,root}from'baobab-react/higher-order';import Baobab from'baobab';import propTypes from'prop-types';import jsonschema,{Validator}from'jsonschema';var createTree=function(){return new Baobab({schema:{},value:{},status:{}})};function undefinedWidgetFactory(s){return function(){return React.createElement('span',null,'Widget for \''+s+'\' was not defined')}}function labeled(s){function t(u){var v=u.schema.required,w=v?'required':'';return React.createElement('div',null,React.createElement('label',{className:u.schema.type+'Field '+w},React.createElement('span',{className:'title'},u.view.title||u.editKey),React.createElement(s,u),React.createElement('span',null,u.view.description),React.createElement('span',null,u.errorMessage)))}return t.defaultProps={editKey:'',errorMessage:[]},t}function onInputChange(s){return function(t){'checkbox'===t.target.type?s(t.target.checked):s(t.target.value)}}function Input(s){return React.createElement('input',{type:s.type,placeholder:s.schema.placeholder,value:s.value||'',className:s.className,onChange:onInputChange(s.onChange),checked:s.checked})}Input.defaultProps={className:void 0,checked:!1};var _typeof='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(s){return typeof s}:function(s){return s&&'function'==typeof Symbol&&s.constructor===Symbol&&s!==Symbol.prototype?'symbol':typeof s},classCallCheck=function(s,t){if(!(s instanceof t))throw new TypeError('Cannot call a class as a function')},_extends=Object.assign||function(s){for(var u,t=1;t<arguments.length;t++)for(var v in u=arguments[t],u)Object.prototype.hasOwnProperty.call(u,v)&&(s[v]=u[v]);return s},inherits=function(s,t){if('function'!=typeof t&&null!==t)throw new TypeError('Super expression must either be null or a function, not '+typeof t);s.prototype=Object.create(t&&t.prototype,{constructor:{value:s,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(s,t):s.__proto__=t)},possibleConstructorReturn=function(s,t){if(!s)throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called');return t&&('object'==typeof t||'function'==typeof t)?t:s};function TextWidget(s){return React.createElement(Input,_extends({},s,{type:'string'}))}var TextWidget$1=labeled(TextWidget);function ArrowNumberWidget(s){return React.createElement(Input,_extends({},s,{type:'number'}))}var ArrowNumberWidget$1=labeled(ArrowNumberWidget);function CheckboxWidget(s){return React.createElement(Input,_extends({},s,{type:'checkbox',checked:s.value}))}CheckboxWidget.defaultProps={value:!1};var CheckboxWidget$1=labeled(CheckboxWidget);function ArrayWidget(s){var t=React.Children.map(s.children,function(u,v){return React.createElement('div',null,React.createElement('button',{onClick:function(){s.onChildRemove(v)}},'-'),u)});return React.createElement('div',null,React.createElement('div',null,t),React.createElement('button',{onClick:s.onChildAdd},'+'))}var ArrayWidget$1=labeled(ArrayWidget);function ObjectWidget(s){return React.createElement('div',null,s.children)}var ObjectWidget$1=labeled(ObjectWidget);function SelectWidget(s){var t=s.view,u=s.value,v=s.onChange,w=t.choices.map(function(x){return React.createElement('option',{key:x.value,value:x.value},x.label)});return React.createElement('select',{value:u,onChange:function(y){return v(y.target.value)}},w)}var DefaultWidget={string:TextWidget$1,number:TextWidget$1,boolean:CheckboxWidget$1,array:ArrayWidget$1,object:ObjectWidget$1,arrowNumber:ArrowNumberWidget$1,select:SelectWidget};function defaultWidget(s){return DefaultWidget[s]||undefinedWidgetFactory(s)}function setDefaultWidgets(s){DefaultWidget=Object.assign({},DefaultWidget,s)}var EMPTYOBJECT={};function Widget(s){var t=s.value,u=s.schema,v=s.children,w=s.editKey,x=s.onChange,y=s.onChildAdd,z=s.onChildRemove,A=s.addKey,B=s.removeKey,C=s.alterKey,D=s.errorMessage,E={value:t,schema:u,children:v,editKey:w,onChange:x,onChildAdd:y,onChildRemove:z,addKey:A,removeKey:B,alterKey:C,errorMessage:D},F=u.view;if(F){var G=F.type;if('string'==typeof G){var H=defaultWidget(G);return React.createElement(H,_extends({},E,{view:F}))}if('function'==typeof G)return React.createElement(G,_extends({},E,{view:F}))}var I=Array.isArray(u.type)?u.type.find(function(K){return'null'!==K}):u.type;void 0===I&&(I='undefinedType');var J=defaultWidget(I);return React.createElement(J,_extends({},E,{view:F||EMPTYOBJECT}))}var customValidator=new Validator;customValidator.attributes.errored=function(s,t,u){if('function'!=typeof t.errored)throw new jsonschema.SchemaError('"errored" expects a function');var v=t.errored(s,u.formValue);return v?v:void 0};function validate(s,t,u){return customValidator.validate(s,t,{formValue:u})}function validated$1(s){return function(t){return React.createElement(s,_extends({},t,{errorMessage:t.actions.getErrors(t.path),onChange:function(u){var v=validate(u,t.schema,t.actions.getFormValue()),w=v.errors.map(function(x){return x.message});t.onChange(u,w)}}))}}var EMPTY_OBJECT={};function renderChildren(s){function t(B){return v[B]&&'number'==typeof v[B].index?v[B].index:0}var u=[],v=s.schema.properties||{},w=s.value||{},x=Object.keys(v);Object.keys(w).forEach(function(B){B in v||x.push(B)}),x.sort(function(B,C){return t(B)-t(C)});for(var y,z=0;z<x.length;z+=1)if(y=x[z],y in v)u.push(React.createElement(SchemaType$1,_extends({},s,{status:s.status[y]||EMPTY_OBJECT,schema:v[y],value:w[y],editKey:y,key:y})));else{var A=s.schema.defaultProperties;A&&s.actions.updateSchema(s.path.concat([y]),A),u.push(React.createElement(SchemaType$1,_extends({},s,{status:s.status[y]||EMPTY_OBJECT,schema:A,value:w[y],editKey:y,key:y})))}return u}function ObjectField(s){return React.createElement(Widget,_extends({},s,{addKey:function(t,u){var v;s.onChange(Object.assign({},s.value,(v={},v[t]=u,v)))},removeKey:function(t){var u=Object.assign({},s.value);delete u[t],s.actions.deleteSchema(s.path.concat([t]),{}),s.onChange(u)},alterKey:function(t,u){var v={};Object.keys(s.value).forEach(function(w){w===t?v[u]=s.value[w]:v[w]=s.value[w]}),s.onChange(v)}}),renderChildren(s))}ObjectField.defaultProps={value:{}};var ObjectField$1=validated$1(ObjectField);function StringField(s){var t=void 0!==s.value&&null!==s.value?s.value+'':s.value;return React.createElement(Widget,_extends({},s,{value:t}))}var StringField$1=validated$1(StringField),NumberField=function(s){function t(u){classCallCheck(this,t);var v=possibleConstructorReturn(this,s.call(this,u));return v.state={value:u.value},v.boundChange=v.onChange.bind(v),v}return inherits(t,s),t.prototype.componentWillReceiveProps=function(v){+this.state.value!=+v.value&&this.setState({value:v.value})},t.prototype.onChange=function(v){var w=this,x=''===v?void 0:v,y=+x;this.setState({value:x},function(){return w.props.onChange(isNaN(y)?x:y)})},t.prototype.render=function(){return React.createElement(StringField,_extends({},this.props,{value:this.state.value,onChange:this.boundChange}))},t}(React.Component),NumberField$1=validated$1(NumberField);function BooleanField(s){return React.createElement(Widget,s)}var BooleanField$1=validated$1(BooleanField),EMPTY_OBJECT$1={};function onChildChange(s,t){return function(u){var v=t.value;v?t.onChange(v.map(function(w,x){return+x==+s?u:w})):t.onChange([u])}}function onChildRemove(s){return function(t){var u=s.value||[];s.onChange(u.filter(function(v,w){return+w!=+t}))}}function onChildAdd(s){return function(){var t=s.value||[];s.onChange(t.concat([void 0]))}}function renderChildren$1(s){var t=s.value,u=s.schema,v=u.value,w=u.items,x;x=t?t:v?v:[];var y=[];return x.forEach(function(z,A){return y.push(React.createElement(SchemaType$1,_extends({},s,{schema:Array.isArray(w)?w[A]||{}:w,value:z,editKey:A+'',status:s.status[A+'']||EMPTY_OBJECT$1,key:A,onChange:onChildChange(A,s)})))}),y}function ArrayField(s){return React.createElement(Widget,_extends({},s,{onChildAdd:onChildAdd(s),onChildRemove:onChildRemove(s)}),renderChildren$1(s))}var ArrayField$1=validated$1(ArrayField),Fields={object:ObjectField$1,string:StringField$1,number:NumberField$1,boolean:BooleanField$1,array:ArrayField$1};function visibility$1(s){return function(t){var u=t.schema.visible,v=t.value;return u&&!u(v,t.actions.getFormValue())?null:React.createElement(s,t)}}function Undefined(s){return React.createElement('span',null,'Undefined field type "'+s.schema.type.toString()+'", ['+s.path.toString()+']')}function infer(s){switch('undefined'==typeof s?'undefined':_typeof(s)){case'number':return'number';case'string':return'string';case'boolean':return'boolean';case'object':return Array.isArray(s)?'array':'object';default:return'string';}}function updatePath(s,t){return t?s.concat([t]):s}function inference(s){var t=function(u){function v(w){classCallCheck(this,v);var x=possibleConstructorReturn(this,u.call(this,w)),y=w.schema,z=y;return z&&'type'in z||(z={type:infer(w.value)}),x.state={schema:z},x}return inherits(v,u),v.prototype.componentWillReceiveProps=function(x){if(this.props.schema!==x.schema){var y=x.schema;y&&'type'in y||(y={type:infer(x.value)}),this.setState(function(){return{schema:y}})}},v.prototype.render=function(){var x=updatePath(this.props.path,this.props.editKey);return React.createElement(s,_extends({},this.props,{path:x,schema:this.state.schema}))},v}(React.Component);return t}function updateDefault(s){var t=s.value,u=s.schema.value,v=void 0===t?u:t;return v}function fromDefaultValue(s){var t=function(u){function v(w){classCallCheck(this,v);var x=possibleConstructorReturn(this,u.call(this,w));return x.state={val:updateDefault(w)},x}return inherits(v,u),v.prototype.componentDidMount=function(){this.notifyDefaultChange()},v.prototype.componentWillReceiveProps=function(x){x.schema===this.props.schema?this.setState({val:x.value}):this.setState({val:updateDefault(x)},this.notifyDefaultChange.bind(this))},v.prototype.notifyDefaultChange=function(){this.props.value!==this.state.val&&this.props.actions.setDefaultValue(this.props.path,this.state.val)},v.prototype.render=function(){return React.createElement(s,_extends({},this.props,{value:this.state.val}))},v}(React.Component);return t}function doAction(s,t){return function(){for(var u=arguments.length,v=Array(u),w=0;w<u;w++)v[w]=arguments[w];s.apply(void 0,[t].concat(v))}}var SchemaType=function(s){function t(u){classCallCheck(this,t);var v=possibleConstructorReturn(this,s.call(this,u));return v.onChange=doAction(u.actions.update,u.path),v}return inherits(t,s),t.prototype.shouldComponentUpdate=function(v){var w=this.props,x=w.editKey,y=w.schema,z=w.value,A=w.status;return x!==v.editKey||y!==v.schema||z!==v.value||A!==v.status},t.prototype.render=function(){var v=this.props.schema.type,w=Array.isArray(v)?v.find(function(y){return'null'!==y}):v,x;return x=null==w||'null'===w?Undefined:Fields[w],React.createElement(x,_extends({},this.props,{onChange:this.onChange}))},t}(React.Component);SchemaType.defaultProps={path:[]};var SchemaType$1=inference(fromDefaultValue(visibility$1(SchemaType))),VALUE='value',STATUS='status',STATE='state',ERRORS='errors',NOERRORS=[];function setErrors(s,t,u){var v=[STATUS].concat(t).concat([ERRORS]),w=s.select(v);u&&u.length&&Array.isArray(w.get())?(w.splice([0,w.get().length]),w.concat(u||[])):w.set(u||NOERRORS)}function update(s,t,u,v){var w=[STATUS].concat(t);s.set([VALUE].concat(t),u),s.set(w.concat([STATE]),'dirty'),setErrors(s,t,v)}function setDefaultValue(s,t,u){s.set([VALUE].concat(t),u),s.set([STATUS].concat(t).concat([STATE]),'pristine')}function getStatus(s,t){return s.get([STATUS].concat(t).concat([STATE]))}function getErrors(s,t){return s.get([STATUS].concat(t).concat([ERRORS]))||NOERRORS}function getFormValue(s){return s.get(VALUE)}function schemaPath(s,t){return t.reduce(function(u,v){return'object'===s.get(u).type?u.concat(['properties',v]):'array'===s.get(u).type?u.concat(['items']):u.concat([v])},['schema'])}function updateSchema(s,t,u){var v=schemaPath(s,t);s.set(v,u)}function deleteSchema(s,t){var u=schemaPath(s,t);s.unset(u)}var actions=Object.freeze({setErrors:setErrors,update:update,setDefaultValue:setDefaultValue,getStatus:getStatus,getErrors:getErrors,getFormValue:getFormValue,updateSchema:updateSchema,deleteSchema:deleteSchema}),BranchedSchemaType=branch({schema:'schema',status:'status',value:'value'},SchemaType$1),Container$1=function(s){function t(u){classCallCheck(this,t);var v=possibleConstructorReturn(this,s.call(this,u));return v.tree=createTree(),v.updateTree(u.value,u.schema),v.ACTIONS={},Object.keys(actions).forEach(function(w){v.ACTIONS[w]=actions[w].bind(v.tree,v.tree)}),v.rooted=root(v.tree,BranchedSchemaType),v}return inherits(t,s),t.prototype.componentDidMount=function(){var v=this;this.tree.select('value').on('update',function(w){return v.props.onChange(w.data.currentData,validate(w.data.currentData,v.tree.get('schema'),w.data.currentData).errors)})},t.prototype.componentWillReceiveProps=function(v){v.value===this.tree.get('value')&&v.schema===this.props.schema||this.updateTree(v.value,v.schema)},t.prototype.componentWillUnmount=function(){this.tree.release()},t.prototype.getValue=function(){return this.tree.get('value')},t.prototype.updateTree=function(v,w){this.tree.set('value',v),this.tree.set('schema',w||{}),this.tree.set('status',{}),this.tree.commit()},t.prototype.validate=function(){var v=validate(this.tree.get('value'),this.tree.get('schema'),this.tree.get('value')),w=this.ACTIONS.setErrors,x=new Map;return v.errors.forEach(function(y){var z=x.get(y.property)||[];z.push(y.message),x.set(y.property,z)}),x.forEach(function(y,z){w(z.split(/\.|\[|\]/).filter(function(A){return''!==A}).slice(1),y)}),v.errors},t.prototype.render=function(){var v=this.rooted;return React.createElement(v,{onChange:this.props.onChange,path:[],actions:this.ACTIONS})},t}(React.Component);Container$1.setDefaultWidgets=setDefaultWidgets;export default Container$1;
//# sourceMappingURL=index.es2015.js.map
