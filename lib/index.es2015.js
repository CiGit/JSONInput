import t from"baobab";import{createElement as e,Component as n}from"react";import{Validator as r,SchemaError as o}from"jsonschema";import{root as a,branch as i}from"baobab-react/higher-order";var u=function(){return new t({schema:{},value:{},status:{}})};function s(t){return function(){return e("span",null,"Widget for '"+t+"' was not defined")}}var c={};function p(t){return c[t]||s(t)}function h(t){c=Object.assign({},c,t)}var f="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},l=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},v=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t},d=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},y=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},m={};function g(t){var n=t.value,r=t.schema,o=t.schema.view,a={value:n,schema:r,children:t.children,editKey:t.editKey,path:t.path,onChange:t.onChange,onChildAdd:t.onChildAdd,onChildRemove:t.onChildRemove,addKey:t.addKey,removeKey:t.removeKey,alterKey:t.alterKey,errorMessage:t.errorMessage};if(o){var i=o.type;if("string"==typeof i){var u=p(i);return e(u,v({},a,{view:o}))}if("function"==typeof i)return e(i,v({},a,{view:o}))}var s=Array.isArray(r.type)?r.type.find(function(t){return"null"!==t}):r.type,c=void 0;return c=p(void 0===s?"undefinedType":s),e(c,v({},a,{view:o||m}))}var b=new r;function C(t,e,n){return b.validate(t,e,{formValue:n})}b.attributes.errored=function(t,e,n){if("function"!=typeof e.errored)throw new o('"errored" expects a function');var r=e.errored(t,n.formValue);if(r)return r};var w="value",j="status",K="state",O="errors",S=[];function A(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments[2],r=[j].concat(e).concat([O]),o=t.select(r);n&&n.length&&Array.isArray(o.get())?(o.splice([0,o.get().length]),o.concat(n||[])):o.set(n||S)}function P(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments[2],r=new Map;n.forEach(function(t){var e=r.get(t.property)||[];e.push(t.message),r.set(t.property,e)}),A(t,e,S),r.forEach(function(n,r){A(t,e.concat(r.split(/\.|\[|\]/).filter(function(t){return""!==t}).slice(1)),n)})}function E(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments[2],r=arguments[3],o=[j].concat(e);t.set([w].concat(e),n),t.set(o.concat([K]),"dirty"),P(t,e,r)}function D(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];E(t,e,arguments[2],[]),t.set([j].concat(e).concat([K]),"pristine")}function R(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return t.get([j].concat(e).concat([O]))||S}function x(t){return t.get(w)}function k(t){return function(n){return e(t,v({},n,{errorMessage:n.dispatch(R,n.path),onChange:function(t){var e=C(t,n.schema,n.dispatch(x));n.onChange(t,e.errors)}}))}}function M(t,e){var n=t.properties,r=void 0===n?{}:n;if(e in r)return r[e]}function N(t,e){var n=t.patternProperties||{},r=Object.keys(n).find(function(t){return new RegExp(t).test(e)});if(r)return n[r]}function T(t,e){return M(t,e)||N(t,e)||t.additionalProperties}var W={};function U(t){var n=[],r=t.schema.properties||{},o=t.value||{},a=Object.keys(r);function i(t){if(r[t]){var e=r[t].index;if("number"==typeof e)return e}return 0}Object.keys(o).forEach(function(t){t in r||a.push(t)}),a.sort(function(t,e){return i(t)-i(e)});for(var u=0;u<a.length;u+=1){var s=a[u],c=T(t.schema,s);n.push(e(ct,v({},t,{status:t.status[s]||W,schema:c,value:o[s],editKey:s,key:u})))}return n}function _(t){return e(g,v({},t,{addKey:function(e,n){var r;if("object"===f(t.value)&&e in t.value)throw new Error('Property "'+e+'" already exists');t.onChange(Object.assign({},t.value,((r={})[e]=n,r)))},removeKey:function(e){var n=Object.assign({},t.value);delete n[e],t.onChange(n)},alterKey:function(e,n){if(e!==n){if(n in t.value)throw new Error('Property "'+n+'" already exists');var r={};Object.keys(t.value).forEach(function(o){o!==e?r[o]=t.value[o]:r[n]=t.value[o]}),t.onChange(r)}}}),U(t))}var V=k(_);function q(t){return e(g,t)}var z=k(q);function B(t){switch(void 0===t?"undefined":f(t)){case"number":return t;case"string":return""===t?void 0:Number(t);default:return}}var F=function(t){function n(e){l(this,n);var r=y(this,t.call(this,e));return r.state={value:e.value},r.onChange=r.onChange.bind(r),r}return d(n,t),n.prototype.componentWillReceiveProps=function(t){B(this.state.value)!==B(t.value)&&this.setState({value:t.value})},n.prototype.onChange=function(t){var e=this,n=""===t?void 0:t,r=Number(n);this.setState({value:n},function(){return e.props.onChange(isNaN(r)?n:r)})},n.prototype.render=function(){return e(q,v({},this.props,{value:this.state.value,onChange:this.onChange}))},n}(n),G=k(F);function H(t){return e(g,t)}var I=k(H),J={};function L(t,e){return function(n){var r=e.value;r?e.onChange(r.map(function(e,r){return+r!=+t?e:n})):e.onChange([n])}}function Q(t){return function(e){var n=t.value||[];t.onChange(n.filter(function(t,n){return Number(n)!==Number(e)}))}}function X(t){return function(e){var n=t.value||[];t.onChange(n.concat([e]))}}function Y(t){var n=t.value,r=t.schema,o=r.value,a=r.items,i=[];return(n||(o||[])).forEach(function(n,r){return i.push(e(ct,v({},t,{schema:Array.isArray(a)?a[r]||{}:a,value:n,editKey:String(r),status:t.status[String(r)]||J,key:r,onChange:L(r,t)})))}),i}function Z(t){return e(g,v({},t,{onChildAdd:X(t),onChildRemove:Q(t)}),Y(t))}var $=k(Z),tt={object:V,string:z,number:G,boolean:I,array:$};function et(t){return function(n){var r=n.schema.visible,o=n.value;try{if(r&&!r(o,n.dispatch(x),n.path.concat()))return null}catch(t){return null}return e(t,n)}}function nt(t){return e("div",null,'Undefined field type "'+t.schema.type.toString()+'", ['+t.path.toString()+"]")}function rt(t){switch(void 0===t?"undefined":f(t)){case"number":return"number";case"string":return"string";case"boolean":return"boolean";case"object":return Array.isArray(t)?"array":"object";default:return"string"}}function ot(t,e){return void 0!==e?t.concat([e]):t}function at(t){return function(n){function r(t){l(this,r);var e=y(this,n.call(this,t)),o=t.schema||{};return"type"in o||(o=v({type:rt(t.value)},o)),e.state={schema:o},e.path=ot(e.props.path,e.props.editKey),e}return d(r,n),r.prototype.componentWillReceiveProps=function(t){if(t.editKey===this.props.editKey&&t.path===this.props.path||(this.path=ot(t.path,t.editKey)),this.props.schema!==t.schema){var e=t.schema||{};"type"in e||(e=v({type:rt(t.value)},e)),this.setState(function(){return{schema:e}})}},r.prototype.render=function(){return e(t,v({},this.props,{path:this.path,schema:this.state.schema}))},r}(n)}function it(t){var e=t.value,n=t.schema.value;return void 0!==e?e:n}function ut(t){return function(n){function r(t){l(this,r);var e=y(this,n.call(this,t));return e.state={val:it(t)},e.notifyDefaultChange(),e}return d(r,n),r.prototype.componentDidMount=function(){},r.prototype.componentWillReceiveProps=function(t){void 0===t.status.state?this.setState({val:it(t)}):this.setState({val:t.value})},r.prototype.componentDidUpdate=function(){this.notifyDefaultChange()},r.prototype.notifyDefaultChange=function(){this.props.value!==this.state.val&&this.props.dispatch(D,this.props.path,this.state.val)},r.prototype.render=function(){return e(t,v({},this.props,{value:this.state.val}))},r}(n)}var st=function(t){function n(e){l(this,n);var r=y(this,t.call(this,e));return r.onChange=r.onChange.bind(r),r}return d(n,t),n.prototype.onChange=function(){for(var t,e=arguments.length,n=Array(e),r=0;r<e;r++)n[r]=arguments[r];(t=this.props).dispatch.apply(t,[E,this.props.path].concat(n))},n.prototype.render=function(){var t=this.props.schema.type,n=Array.isArray(t)?t.find(function(t){return"null"!==t}):t,r=void 0;return void 0===(r=void 0===n||"null"===n?nt:tt[n])&&(r=nt),e(r,v({},this.props,{onChange:this.onChange}))},n}(n);st.defaultProps={path:[]};var ct=at(ut(et(st))),pt=i({schema:"schema",status:"status",value:"value"},ct);function ht(){}var ft=function(t){function n(e){l(this,n);var r=y(this,t.call(this,e));return r.event=!1,r.tree=u(),r.updateTree(e.value,e.schema),r.rooted=a(r.tree,pt),r}return d(n,t),n.prototype.componentDidMount=function(){var t=this;this.tree.select("value").on("update",function(e){t.event&&t.props.onChange(e.data.currentData,C(e.data.currentData,t.tree.get("schema"),e.data.currentData).errors)})},n.prototype.componentWillReceiveProps=function(t){t.value===this.tree.get("value")&&t.schema===this.props.schema||this.updateTree(t.value,t.schema)},n.prototype.componentWillUnmount=function(){this.tree.release()},n.prototype.shouldComponentUpdate=function(){return!1},n.prototype.getValue=function(){return this.tree.get("value")},n.prototype.updateTree=function(t,e){this.event=!1,this.tree.set("value",t),this.tree.set("schema",e),this.tree.set("status",{}),this.tree.commit(),this.event=!0},n.prototype.validate=function(){var t=C(this.tree.get("value"),this.tree.get("schema"),this.tree.get("value"));return P(this.tree,[],t.errors),t.errors},n.prototype.render=function(){var t=this.rooted;return e(t,{onChange:ht,path:[]})},n}(n);ft.defaultProps={schema:{}};export default ft;export{h as setDefaultWidgets};
//# sourceMappingURL=index.es2015.js.map
