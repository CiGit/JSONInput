import React from'react';import{branch,root}from'baobab-react/higher-order';import Baobab from'baobab';import propTypes from'prop-types';import jsonschema,{Validator}from'jsonschema';var createTree=function(){return new Baobab({schema:{},value:{},status:{}})};function undefinedWidgetFactory(t){return function(){return React.createElement('span',null,'Widget for \''+t+'\' was not defined')}}function labeled(t){function u(v){var w=v.schema.required,x=w?'required':'';return React.createElement('div',null,React.createElement('label',{className:v.schema.type+'Field '+x},React.createElement('span',{className:'title'},v.view.title||v.editKey),React.createElement(t,v),React.createElement('span',null,v.view.description),React.createElement('span',null,v.errorMessage)))}return u.defaultProps={editKey:'',errorMessage:[]},u}function onInputChange(t){return function(u){'checkbox'===u.target.type?t(u.target.checked):t(u.target.value)}}function Input(t){return React.createElement('input',{type:t.type,placeholder:t.schema.placeholder,value:t.value||'',className:t.className,onChange:onInputChange(t.onChange),checked:t.checked})}Input.defaultProps={className:void 0,checked:!1};var _typeof='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&'function'==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?'symbol':typeof t},classCallCheck=function(t,u){if(!(t instanceof u))throw new TypeError('Cannot call a class as a function')},_extends=Object.assign||function(t){for(var v,u=1;u<arguments.length;u++)for(var w in v=arguments[u],v)Object.prototype.hasOwnProperty.call(v,w)&&(t[w]=v[w]);return t},inherits=function(t,u){if('function'!=typeof u&&null!==u)throw new TypeError('Super expression must either be null or a function, not '+typeof u);t.prototype=Object.create(u&&u.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),u&&(Object.setPrototypeOf?Object.setPrototypeOf(t,u):t.__proto__=u)},possibleConstructorReturn=function(t,u){if(!t)throw new ReferenceError('this hasn\'t been initialised - super() hasn\'t been called');return u&&('object'==typeof u||'function'==typeof u)?u:t};function TextWidget(t){return React.createElement(Input,_extends({},t,{type:'string'}))}var TextWidget$1=labeled(TextWidget);function ArrowNumberWidget(t){return React.createElement(Input,_extends({},t,{type:'number'}))}var ArrowNumberWidget$1=labeled(ArrowNumberWidget);function CheckboxWidget(t){return React.createElement(Input,_extends({},t,{type:'checkbox',checked:t.value}))}CheckboxWidget.defaultProps={value:!1};var CheckboxWidget$1=labeled(CheckboxWidget);function ArrayWidget(t){var u=React.Children.map(t.children,function(v,w){return React.createElement('div',null,React.createElement('button',{onClick:function(){t.onChildRemove(w)}},'-'),v)});return React.createElement('div',null,React.createElement('div',null,u),React.createElement('button',{onClick:t.onChildAdd},'+'))}var ArrayWidget$1=labeled(ArrayWidget);function ObjectWidget(t){return React.createElement('div',null,t.children)}var ObjectWidget$1=labeled(ObjectWidget);function SelectWidget(t){var u=t.view,v=t.value,w=t.onChange,x=u.choices.map(function(y){return React.createElement('option',{key:y.value,value:y.value},y.label)});return React.createElement('select',{value:v,onChange:function(z){return w(z.target.value)}},x)}var DefaultWidget={string:TextWidget$1,number:TextWidget$1,boolean:CheckboxWidget$1,array:ArrayWidget$1,object:ObjectWidget$1,arrowNumber:ArrowNumberWidget$1,select:SelectWidget};function defaultWidget(t){return DefaultWidget[t]||undefinedWidgetFactory(t)}function setDefaultWidgets(t){DefaultWidget=Object.assign({},DefaultWidget,t)}var EMPTYOBJECT={};function Widget(t){var u=t.value,v=t.schema,w=t.children,x=t.editKey,y=t.path,z=t.onChange,A=t.onChildAdd,B=t.onChildRemove,C=t.addKey,D=t.removeKey,E=t.alterKey,F=t.errorMessage,G={value:u,schema:v,children:w,editKey:x,path:y,onChange:z,onChildAdd:A,onChildRemove:B,addKey:C,removeKey:D,alterKey:E,errorMessage:F},H=v.view;if(H){var I=H.type;if('string'==typeof I){var J=defaultWidget(I);return React.createElement(J,_extends({},G,{view:H}))}if('function'==typeof I)return React.createElement(I,_extends({},G,{view:H}))}var K=Array.isArray(v.type)?v.type.find(function(M){return'null'!==M}):v.type;void 0===K&&(K='undefinedType');var L=defaultWidget(K);return React.createElement(L,_extends({},G,{view:H||EMPTYOBJECT}))}var customValidator=new Validator;customValidator.attributes.errored=function(t,u,v){if('function'!=typeof u.errored)throw new jsonschema.SchemaError('"errored" expects a function');var w=u.errored(t,v.formValue);return w?w:void 0};function validate(t,u,v){return customValidator.validate(t,u,{formValue:v})}var VALUE='value',STATUS='status',STATE='state',ERRORS='errors',NOERRORS=[];function setErrors(t,u,v){var w=[STATUS].concat(u).concat([ERRORS]),x=t.select(w);v&&v.length&&Array.isArray(x.get())?(x.splice([0,x.get().length]),x.concat(v||[])):x.set(v||NOERRORS)}function update(t,u,v,w){var x=[STATUS].concat(u);t.set([VALUE].concat(u),v),t.set(x.concat([STATE]),'dirty'),setErrors(t,u,w)}function setDefaultValue(t,u,v){t.set([VALUE].concat(u),v),t.set([STATUS].concat(u).concat([STATE]),'pristine')}function getErrors(t,u){return t.get([STATUS].concat(u).concat([ERRORS]))||NOERRORS}function getFormValue(t){return t.get(VALUE)}function schemaPath(t,u){return u.reduce(function(v,w){return'object'===t.get(v).type?v.concat(['properties',w]):'array'===t.get(v).type?v.concat(['items']):v.concat([w])},['schema'])}function updateSchema(t,u,v){var w=schemaPath(t,u);t.set(w,v)}function deleteSchema(t,u){var v=schemaPath(t,u);t.unset(v)}function validated$1(t){return function(u){return React.createElement(t,_extends({},u,{errorMessage:u.dispatch(getErrors,u.path),onChange:function(v){var w=validate(v,u.schema,u.dispatch(getFormValue)),x=w.errors.map(function(y){return y.message});u.onChange(v,x)}}))}}var EMPTY_OBJECT={};function renderChildren(t){function u(C){return w[C]&&'number'==typeof w[C].index?w[C].index:0}var v=[],w=t.schema.properties||{},x=t.value||{},y=Object.keys(w);Object.keys(x).forEach(function(C){C in w||y.push(C)}),y.sort(function(C,D){return u(C)-u(D)});for(var z,A=0;A<y.length;A+=1)if(z=y[A],z in w)v.push(React.createElement(SchemaType$1,_extends({},t,{status:t.status[z]||EMPTY_OBJECT,schema:w[z],value:x[z],editKey:z,key:z})));else{var B=t.schema.defaultProperties;B&&t.dispatch(updateSchema,t.path.concat([z]),B),v.push(React.createElement(SchemaType$1,_extends({},t,{status:t.status[z]||EMPTY_OBJECT,schema:B,value:x[z],editKey:z,key:z})))}return v}function ObjectField(t){return React.createElement(Widget,_extends({},t,{addKey:function(u,v){var w;t.onChange(Object.assign({},t.value,(w={},w[u]=v,w)))},removeKey:function(u){var v=Object.assign({},t.value);delete v[u],t.dispatch(deleteSchema,t.path.concat([u]),{}),t.onChange(v)},alterKey:function(u,v){var w={};Object.keys(t.value).forEach(function(x){x===u?w[v]=t.value[x]:w[x]=t.value[x]}),t.onChange(w)}}),renderChildren(t))}ObjectField.defaultProps={value:{}};var ObjectField$1=validated$1(ObjectField);function StringField(t){var u=void 0!==t.value&&null!==t.value?t.value+'':t.value;return React.createElement(Widget,_extends({},t,{value:u}))}var StringField$1=validated$1(StringField),NumberField=function(t){function u(v){classCallCheck(this,u);var w=possibleConstructorReturn(this,t.call(this,v));return w.state={value:v.value},w.boundChange=w.onChange.bind(w),w}return inherits(u,t),u.prototype.componentWillReceiveProps=function(w){+this.state.value!=+w.value&&this.setState({value:w.value})},u.prototype.onChange=function(w){var x=this,y=''===w?void 0:w,z=+y;this.setState({value:y},function(){return x.props.onChange(isNaN(z)?y:z)})},u.prototype.render=function(){return React.createElement(StringField,_extends({},this.props,{value:this.state.value,onChange:this.boundChange}))},u}(React.Component),NumberField$1=validated$1(NumberField);function BooleanField(t){return React.createElement(Widget,t)}var BooleanField$1=validated$1(BooleanField),EMPTY_OBJECT$1={};function onChildChange(t,u){return function(v){var w=u.value;w?u.onChange(w.map(function(x,y){return+y==+t?v:x})):u.onChange([v])}}function onChildRemove(t){return function(u){var v=t.value||[];t.onChange(v.filter(function(w,x){return+x!=+u}))}}function onChildAdd(t){return function(){var u=t.value||[];t.onChange(u.concat([void 0]))}}function renderChildren$1(t){var u=t.value,v=t.schema,w=v.value,x=v.items,y;y=u?u:w?w:[];var z=[];return y.forEach(function(A,B){return z.push(React.createElement(SchemaType$1,_extends({},t,{schema:Array.isArray(x)?x[B]||{}:x,value:A,editKey:B+'',status:t.status[B+'']||EMPTY_OBJECT$1,key:B,onChange:onChildChange(B,t)})))}),z}function ArrayField(t){return React.createElement(Widget,_extends({},t,{onChildAdd:onChildAdd(t),onChildRemove:onChildRemove(t)}),renderChildren$1(t))}var ArrayField$1=validated$1(ArrayField),Fields={object:ObjectField$1,string:StringField$1,number:NumberField$1,boolean:BooleanField$1,array:ArrayField$1};function visibility$1(t){return function(u){var v=u.schema.visible,w=u.value;return v&&!v(w,u.dispatch(getFormValue))?null:React.createElement(t,u)}}function Undefined(t){return React.createElement('span',null,'Undefined field type "'+t.schema.type.toString()+'", ['+t.path.toString()+']')}function infer(t){switch('undefined'==typeof t?'undefined':_typeof(t)){case'number':return'number';case'string':return'string';case'boolean':return'boolean';case'object':return Array.isArray(t)?'array':'object';default:return'string';}}function updatePath(t,u){return u?t.concat([u]):t}function inference(t){var u=function(v){function w(x){classCallCheck(this,w);var y=possibleConstructorReturn(this,v.call(this,x)),z=x.schema,A=z;return A&&'type'in A||(A={type:infer(x.value)}),y.state={schema:A},y}return inherits(w,v),w.prototype.componentWillReceiveProps=function(y){if(this.props.schema!==y.schema){var z=y.schema;z&&'type'in z||(z={type:infer(y.value)}),this.setState(function(){return{schema:z}})}},w.prototype.render=function(){var y=updatePath(this.props.path,this.props.editKey);return React.createElement(t,_extends({},this.props,{path:y,schema:this.state.schema}))},w}(React.Component);return u}function updateDefault(t){var u=t.value,v=t.schema.value,w=void 0===u?v:u;return w}function fromDefaultValue(t){var u=function(v){function w(x){classCallCheck(this,w);var y=possibleConstructorReturn(this,v.call(this,x));return y.state={val:updateDefault(x)},y}return inherits(w,v),w.prototype.componentDidMount=function(){this.notifyDefaultChange()},w.prototype.componentWillReceiveProps=function(y){y.schema===this.props.schema?this.setState({val:y.value}):this.setState({val:updateDefault(y)})},w.prototype.componentDidUpdate=function(){this.notifyDefaultChange()},w.prototype.notifyDefaultChange=function(){this.props.value!==this.state.val&&this.props.dispatch(setDefaultValue,this.props.path,this.state.val)},w.prototype.render=function(){return React.createElement(t,_extends({},this.props,{value:this.state.val}))},w}(React.Component);return u}var SchemaType=function(t){function u(v){classCallCheck(this,u);var w=possibleConstructorReturn(this,t.call(this,v));return w.onChange=function(){for(var x=arguments.length,y=Array(x),z=0;z<x;z++)y[z]=arguments[z];v.dispatch.apply(v,[update,v.path].concat(y))},w}return inherits(u,t),u.prototype.shouldComponentUpdate=function(w){var x=this.props,y=x.editKey,z=x.schema,A=x.value,B=x.status;return y!==w.editKey||z!==w.schema||A!==w.value||B!==w.status},u.prototype.render=function(){var w=this.props.schema.type,x=Array.isArray(w)?w.find(function(z){return'null'!==z}):w,y;return y=null==x||'null'===x?Undefined:Fields[x],React.createElement(y,_extends({},this.props,{onChange:this.onChange}))},u}(React.Component);SchemaType.defaultProps={path:[]};var SchemaType$1=inference(fromDefaultValue(visibility$1(SchemaType))),BranchedSchemaType=branch({schema:'schema',status:'status',value:'value'},SchemaType$1),Container$1=function(t){function u(v){classCallCheck(this,u);var w=possibleConstructorReturn(this,t.call(this,v));return w.tree=createTree(),w.updateTree(v.value,v.schema),w.rooted=root(w.tree,BranchedSchemaType),w}return inherits(u,t),u.prototype.componentDidMount=function(){var w=this;this.tree.select('value').on('update',function(x){return w.props.onChange(x.data.currentData,validate(x.data.currentData,w.tree.get('schema'),x.data.currentData).errors)})},u.prototype.componentWillReceiveProps=function(w){w.value===this.tree.get('value')&&w.schema===this.props.schema||this.updateTree(w.value,w.schema)},u.prototype.componentWillUnmount=function(){this.tree.release()},u.prototype.getValue=function(){return this.tree.get('value')},u.prototype.updateTree=function(w,x){this.tree.set('value',w),this.tree.set('schema',x),this.tree.set('status',{})},u.prototype.validate=function(){var w=this,x=validate(this.tree.get('value'),this.tree.get('schema'),this.tree.get('value')),y=new Map;return x.errors.forEach(function(z){var A=y.get(z.property)||[];A.push(z.message),y.set(z.property,A)}),y.forEach(function(z,A){setErrors(w.tree,A.split(/\.|\[|\]/).filter(function(B){return''!==B}).slice(1),z)}),x.errors},u.prototype.render=function(){var w=this.rooted;return React.createElement(w,{onChange:this.props.onChange,path:[]})},u}(React.Component);Container$1.defaultProps={schema:{}},Container$1.setDefaultWidgets=setDefaultWidgets;export default Container$1;
//# sourceMappingURL=index.es2015.js.map
