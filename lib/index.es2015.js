import{createContext as e,createElement as t,Component as r}from"react";import n from"immer";import{Validator as a,SchemaError as o}from"jsonschema";import{setWith as i,unset as s,get as u,isEqual as c,cloneDeep as p}from"lodash-es";function h(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function l(){return(l=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function f(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),r.push.apply(r,n)}return r}function v(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t}function d(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}var y=e({value:void 0,schema:{},status:{}}),m=y.Consumer,g=function(e){function r(){for(var t,r=arguments.length,a=new Array(r),o=0;o<r;o++)a[o]=arguments[o];return h(d(t=e.call.apply(e,[this].concat(a))||this),"state",{schema:{},value:{},extValue:{},status:{},oldProps:{}}),h(d(t),"dispatch",function(e){for(var r=arguments.length,a=new Array(r>1?r-1:0),o=1;o<r;o++)a[o-1]=arguments[o];t.setState(function(t){return n(e).apply(void 0,[t].concat(a))})}),t}v(r,e),r.getDerivedStateFromProps=function(e,t){if(t.oldProps!==e){var r={value:e.value,schema:e.schema,oldProps:e};return e.value!==t.extValue&&(r.status={},r.extValue=e.value),r}return null};var a=r.prototype;return a.shouldComponentUpdate=function(e,t){return this.state!==t},a.componentDidUpdate=function(e,t){var r=this;if(this.state.value!==t.value&&this.props.value===e.value){var n=this.state.value;this.setState({extValue:n},function(){return r.props.onValueChange(n)})}},a.render=function(){var e=this.state,r=e.schema,n=e.value,a=e.status,o=null!=n?JSON.parse(JSON.stringify(n)):n;return t(y.Provider,{value:{schema:r,value:o,status:a}},this.props.children({schema:r,value:o,status:a,dispatch:this.dispatch}))},r}(r);var b={};function w(e){return b[e]||function(e){return function(){return t("span",null,"Widget for '"+e+"' was not defined")}}(e)}function C(e){b=Object.assign({},b,e)}var O={};function j(e){var r=e.value,n=e.schema,a=e.schema.view,o=e.__tree.value,i={value:r,schema:n,children:e.children,editKey:e.editKey,path:e.path,onChange:e.onChange,onChildAdd:e.onChildAdd,onChildRemove:e.onChildRemove,addKey:e.addKey,removeKey:e.removeKey,alterKey:e.alterKey,errorMessage:e.errorMessage};if(a){var s=a.type;if("string"==typeof s){var u=w(s);return t(u,l({},i,{formValue:o,view:a}))}if("function"==typeof s)return t(s,l({},i,{formValue:o,view:a}))}var c,p=Array.isArray(n.type)?n.type.find(function(e){return"null"!==e}):n.type;return c=w(void 0===p?"undefinedType":p),t(c,l({},i,{formValue:o,view:a||O}))}var P=new a;function K(e,t,r,n){return P.validate(e,t,{formValue:r||{},ctx:{basePath:n}})}P.attributes.errored=function(e,t,r,n){if("function"!=typeof t.errored)throw new o('"errored" expects a function');var a=(r.ctx.basePath||[]).concat(n.propertyPath.split(".").slice(1)),i=t.errored(e,r.formValue,a);if(i)return i};var A="value",k="status",S="$$$state",_="$$$errors",x=[];function E(e,t,r){void 0===t&&(t=[]);var n=[k].concat(t).concat([_]);i(e,n,r,Object)}function V(e,t,r){void 0===t&&(t=[]);var n=new Map;r.forEach(function(e){var t=n.get(e.property)||[];t.push(e.message),n.set(e.property,t)}),E(e,t,x),n.forEach(function(r,n){E(e,t.concat(n.split(/\.|\[|\]/).filter(function(e){return""!==e}).slice(1)),r)})}function D(e,t,r,n){void 0===t&&(t=[]);var a=[k].concat(t);i(e,[A].concat(t),r,Object),i(e,a.concat([S]),"dirty",Object),V(e,t,n)}function N(e,t,r){void 0===t&&(t=[]),D(e,t,r,[]),i(e,[k].concat(t).concat([S]),"pristine",Object)}function M(e,t){void 0===t&&(t=[]);try{s(e,[k].concat(t))}catch(e){}}function $(e,t){return void 0===t&&(t=[]),u(e,[k].concat(t).concat([_]))||x}function R(e){var n=function(r){function n(){for(var e,t=arguments.length,n=new Array(t),a=0;a<t;a++)n[a]=arguments[a];return h(d(e=r.call.apply(r,[this].concat(n))||this),"onChange",function(t){var r=K(t,e.props.schema,e.props.__tree.value,e.props.path);e.props.onChange(t,r.errors)}),e}v(n,r);var a=n.prototype;return a.shouldComponentUpdate=function(e){return this.props.value!==e.value||this.props.schema!==e.schema||$(this.props.__tree,this.props.path)!==$(e.__tree,e.path)},a.render=function(){var r=this.props.path;return t(e,l({},this.props,{errorMessage:$(this.props.__tree,r),onChange:this.onChange}))},n}(r);return function(e){return t(m,null,function(r){return t(n,l({},e,{__tree:r}))})}}function U(e,t){return function(e,t){var r=e.properties,n=void 0===r?{}:r;if(t in n)return n[t]}(e,t)||function(e,t){var r=e.patternProperties||{},n=Object.keys(r).find(function(e){return new RegExp(e).test(t)});if(n)return r[n]}(e,t)||e.additionalProperties}var F={},I=R(function(e){function r(){for(var t,r=arguments.length,n=new Array(r),a=0;a<r;a++)n[a]=arguments[a];return h(d(t=e.call.apply(e,[this].concat(n))||this),"keys",new Map),h(d(t),"keyId",0),h(d(t),"addKey",function(e,r){var n;if("object"==typeof t.props.value&&e in t.props.value)throw new Error('Property "'+e+'" already exists');t.keys.set(e,String(t.keyId++)),t.props.onChange(Object.assign({},t.props.value,((n={})[e]=r,n)))}),h(d(t),"removeKey",function(e){var r=Object.assign({},t.props.value);delete r[e],t.keys.delete(e),t.props.onChange(r)}),h(d(t),"alterKey",function(e,r){if(e!==r){if(r in t.props.value)throw new Error('Property "'+r+'" already exists');var n={};Object.keys(t.props.value).forEach(function(a){a!==e?n[a]=t.props.value[a]:n[r]=t.props.value[a]});var a=t.keys.get(e);t.keys.delete(e),t.keys.set(r,a),t.props.onChange(n)}}),t}v(r,e);var n=r.prototype;return n.renderChildren=function(e){var r=[],n=e.schema.properties||{},a=e.value||{},o=Object.keys(n);function i(e){if(n[e]){var t=n[e].index;if("number"==typeof t)return t}return 0}Object.keys(a).forEach(function(e){e in n||o.push(e)}),o.sort(function(e,t){return i(e)-i(t)});for(var s=new Map,u=0;u<o.length;u+=1){var c=o[u],p=U(e.schema,c);this.keys.has(c)?s.set(c,this.keys.get(c)):s.set(c,String(this.keyId++)),r.push(t(te,l({},e,{status:e.status[c]||F,schema:p,value:a[c],editKey:c,key:s.get(c)})))}return this.keys=s,r},n.render=function(){return t(j,l({},this.props,{addKey:this.addKey,removeKey:this.removeKey,alterKey:this.alterKey}),this.renderChildren(this.props))},r}(r));function J(e){return t(j,e)}var W=R(J);function T(e){switch(typeof e){case"number":return e;case"string":return""===e?void 0:Number(e);default:return}}var q=function(e){function r(){for(var t,r=arguments.length,n=new Array(r),a=0;a<r;a++)n[a]=arguments[a];return h(d(t=e.call.apply(e,[this].concat(n))||this),"state",{value:t.props.value}),h(d(t),"onChange",function(e){var r=""===e?void 0:e,n=Number(r);t.setState({value:r},function(){return t.props.onChange(isNaN(n)?r:n)})}),t}return v(r,e),r.prototype.render=function(){return t(J,l({},this.props,{value:this.state.value,onChange:this.onChange}))},r}(r);h(q,"getDerivedStateFromProps",function(e,t){return T(t.value)!==T(e.value)?{value:e.value}:null});var z=R(q);var B=R(function(e){return t(j,e)}),G={};function H(e){return function(t){var r=e.value||[];e.onChange(r.filter(function(e,r){return Number(r)!==Number(t)}))}}function L(e){return function(t){var r=e.value||[];e.onChange(r.concat([t]))}}var Q={object:I,string:W,number:z,boolean:B,array:R(function(e){return t(j,l({},e,{onChildAdd:L(e),onChildRemove:H(e)}),function(e){var r=e.value,n=e.schema.items,a=[];return(r||[]).forEach(function(r,o){return a.push(t(te,l({},e,{schema:Array.isArray(n)?n[o]||{}:n,value:r,editKey:String(o),status:e.status[String(o)]||G,key:o})))}),a}(e))})};function X(e){return t("div",null,'Undefined field type "'+e.schema.type.toString()+'", ['+e.path.toString()+"]")}function Y(e){switch(typeof e){case"number":return"number";case"string":return"string";case"boolean":return"boolean";case"object":return Array.isArray(e)?"array":"object";default:return"string"}}var Z=function(e){function r(t){var r;return(r=e.call(this,t)||this).onChange=r.onChange.bind(d(r)),r}v(r,e);var n=r.prototype;return n.onChange=function(){for(var e,t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n];(e=this.props).dispatch.apply(e,[D,this.props.path].concat(r))},n.componentWillUnmount=function(){this.props.dispatch(M,this.props.path)},n.render=function(){var e,r=this.props.schema.type,n=Array.isArray(r)?r.find(function(e){return"null"!==e}):r;return void 0===(e=void 0===n||"null"===n?X:Q[n])&&(e=X),t(e,l({},this.props,{onChange:this.onChange}))},r}(r);h(Z,"defaultProps",{path:[]});var ee,te=function(e){return function(r){function n(){for(var e,t=arguments.length,n=new Array(t),a=0;a<t;a++)n[a]=arguments[a];return h(d(e=r.call.apply(r,[this].concat(n))||this),"state",{path:[],schema:{}}),e}return v(n,r),n.getDerivedStateFromProps=function(e,t){var r,n,a={};if(t.oldEditKey===e.editKey&&t.oldPath===e.path||(a.path=(r=e.path,void 0!==(n=e.editKey)?r.concat([n]):r),a.oldPath=e.path,a.oldEditKey=e.editKey),t.schema!==e.schema||Y(e.value)!==Y(t.oldValue)){var o=e.schema||{};"type"in o||(o=function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?f(r,!0).forEach(function(t){h(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):f(r).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}({type:Y(e.value)},o)),a.schema=o}return a},n.prototype.render=function(){var r=this.state.schema.type;return t(e,l({key:Array.isArray(r)?void 0:r},this.props,{path:this.state.path,schema:this.state.schema}))},n}(r)}(function(e){return function(r){function n(){for(var e,t,n,a,o,i,s,u=arguments.length,c=new Array(u),l=0;l<u;l++)c[l]=arguments[l];return h(d(e=r.call.apply(r,[this].concat(c))||this),"state",{val:(t=e.props,n=t.value,a=t.schema.value,o=t.dispatch,i=t.path,s=void 0!==n?n:p(a),s!==n&&o(N,i,s),s),init:!0}),e}return v(n,r),n.getDerivedStateFromProps=function(e,t){var r=e.schema,n=e.value,a=e.dispatch,o=e.path;if("const"in r&&!c(r.const,n)){var i=p(r.const);return a(N,o,i),{val:i}}return t.init?{init:!1}:{val:e.value}},n.prototype.render=function(){return t(e,l({},this.props,{value:this.state.val}))},n}(r)}((ee=Z,function(e){var r=e.schema.visible,n=e.value;return t(m,null,function(a){var o=a.value;try{if(r&&!r(n,o,e.path.concat()))return null}catch(e){return null}return t(ee,e)})}))),re=[],ne=function(e){function r(){for(var t,r=arguments.length,n=new Array(r),a=0;a<r;a++)n[a]=arguments[a];return h(d(t=e.call.apply(e,[this].concat(n))||this),"store",null),h(d(t),"update",function(e){t.props.onChange(e,K(e,t.props.schema,e).errors)}),t}v(r,e);var n=r.prototype;return n.getValue=function(){return this.store.state.value},n.validate=function(){var e=K(this.store.state.value,this.store.state.schema,this.store.state.value);return this.store.dispatch(V,[],e.errors),e.errors},n.render=function(){var e=this;return t(g,{ref:function(t){e.store=t},value:this.props.value,schema:this.props.schema,onValueChange:this.update},function(e){var r=e.schema,n=e.value,a=e.status,o=e.dispatch;return t(te,{schema:r,dispatch:o,value:n,path:re,status:a})})},r}(r);h(ne,"defaultProps",{schema:{}});export default ne;export{C as setDefaultWidgets};
//# sourceMappingURL=index.es2015.js.map
