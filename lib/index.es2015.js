import t from"baobab";import{createElement as e,Component as n}from"react";import{Validator as r,SchemaError as o}from"jsonschema";import{root as a,branch as i}from"baobab-react/higher-order";var u=function(){return new t({schema:{},value:{},status:{}})};function s(t){return function(){return e("span",null,"Widget for '"+t+"' was not defined")}}var c={};function h(t){return c[t]||s(t)}function p(t){c=Object.assign({},c,t)}var f="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},l=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},v=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var n=arguments[e];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t},y=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},d=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},m={};function g(t){var n=t.value,r=t.schema,o=t.schema.view,a={value:n,schema:r,children:t.children,editKey:t.editKey,path:t.path,onChange:t.onChange,onChildAdd:t.onChildAdd,onChildRemove:t.onChildRemove,addKey:t.addKey,removeKey:t.removeKey,alterKey:t.alterKey,errorMessage:t.errorMessage};if(o){var i=o.type;if("string"==typeof i){var u=h(i);return e(u,v({},a,{view:o}))}if("function"==typeof i)return e(i,v({},a,{view:o}))}var s=Array.isArray(r.type)?r.type.find(function(t){return"null"!==t}):r.type,c=void 0;return c=h(void 0===s?"undefinedType":s),e(c,v({},a,{view:o||m}))}var b=new r;function C(t,e,n){return b.validate(t,e,{formValue:n})}b.attributes.errored=function(t,e,n){if("function"!=typeof e.errored)throw new o('"errored" expects a function');var r=e.errored(t,n.formValue);if(r)return r};var w="value",K="status",j="state",S="errors",A=[];function O(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments[2],r=[K].concat(e).concat([S]),o=t.select(r);n&&n.length&&Array.isArray(o.get())?(o.splice([0,o.get().length]),o.concat(n||[])):o.set(n||A)}function P(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments[2],r=new Map;n.forEach(function(t){var e=r.get(t.property)||[];e.push(t.message),r.set(t.property,e)}),O(t,e,A),r.forEach(function(n,r){O(t,e.concat(r.split(/\.|\[|\]/).filter(function(t){return""!==t}).slice(1)),n)})}function E(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments[2],r=arguments[3],o=[K].concat(e);t.set([w].concat(e),n),t.set(o.concat([j]),"dirty"),P(t,e,r)}function D(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments[2];t.set([w].concat(e),n),t.set([K].concat(e).concat([j]),"pristine")}function R(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return t.get([K].concat(e).concat([S]))||A}function x(t){return t.get(w)}function N(t){return function(n){return e(t,v({},n,{errorMessage:n.dispatch(R,n.path),onChange:function(t){var e=C(t,n.schema,n.dispatch(x));n.onChange(t,e.errors)}}))}}var k={};function M(t){var n=[],r=t.schema.properties||{},o=t.value||{},a=Object.keys(r);function i(t){if(r[t]){var e=r[t].index;if("number"==typeof e)return e}return 0}Object.keys(o).forEach(function(t){t in r||a.push(t)}),a.sort(function(t,e){return i(t)-i(e)});for(var u=0;u<a.length;u+=1){var s=a[u];if(s in r)n.push(e(at,v({},t,{status:t.status[s]||k,schema:r[s],value:o[s],editKey:s,key:u})));else{var c=t.schema.additionalProperties;n.push(e(at,v({},t,{status:t.status[s]||k,schema:c,value:o[s],editKey:s,key:u})))}}return n}function T(t){return e(g,v({},t,{addKey:function(e,n){var r;if("object"===f(t.value)&&e in t.value)throw new Error('Property "'+e+'" already exists');t.onChange(Object.assign({},t.value,((r={})[e]=n,r)))},removeKey:function(e){var n=Object.assign({},t.value);delete n[e],t.onChange(n)},alterKey:function(e,n){if(e!==n){if(n in t.value)throw new Error('Property "'+e+'" already exists');var r={};Object.keys(t.value).forEach(function(o){o!==e?r[o]=t.value[o]:r[n]=t.value[o]}),t.onChange(r)}}}),M(t))}var W=N(T);function U(t){return e(g,t)}var _=N(U),V=function(t){function n(e){l(this,n);var r=d(this,t.call(this,e));return r.state={value:e.value},r.boundChange=r.onChange.bind(r),r}return y(n,t),n.prototype.componentWillReceiveProps=function(t){Number(this.state.value)!==Number(t.value)&&this.setState({value:t.value})},n.prototype.onChange=function(t){var e=this,n=""===t?void 0:t,r=Number(n);this.setState({value:n},function(){return e.props.onChange(isNaN(r)?n:r)})},n.prototype.render=function(){return e(U,v({},this.props,{value:this.state.value,onChange:this.boundChange}))},n}(n),q=N(V);function z(t){return e(g,t)}var B=N(z),F={};function G(t,e){return function(n){var r=e.value;r?e.onChange(r.map(function(e,r){return+r!=+t?e:n})):e.onChange([n])}}function H(t){return function(e){var n=t.value||[];t.onChange(n.filter(function(t,n){return Number(n)!==Number(e)}))}}function I(t){return function(e){var n=t.value||[];t.onChange(n.concat([e]))}}function J(t){var n=t.value,r=t.schema,o=r.value,a=r.items,i=[];return(n||(o||[])).forEach(function(n,r){return i.push(e(at,v({},t,{schema:Array.isArray(a)?a[r]||{}:a,value:n,editKey:String(r),status:t.status[String(r)]||F,key:r,onChange:G(r,t)})))}),i}function L(t){return e(g,v({},t,{onChildAdd:I(t),onChildRemove:H(t)}),J(t))}var Q=N(L),X={object:W,string:_,number:q,boolean:B,array:Q};function Y(t){return function(n){var r=n.schema.visible,o=n.value;try{if(r&&!r(o,n.dispatch(x),n.path.concat()))return null}catch(t){return null}return e(t,n)}}function Z(t){return e("div",null,'Undefined field type "'+t.schema.type.toString()+'", ['+t.path.toString()+"]")}function $(t){switch(void 0===t?"undefined":f(t)){case"number":return"number";case"string":return"string";case"boolean":return"boolean";case"object":return Array.isArray(t)?"array":"object";default:return"string"}}function tt(t,e){return void 0!==e?t.concat([e]):t}function et(t){return function(n){function r(t){l(this,r);var e=d(this,n.call(this,t)),o=t.schema||{};return"type"in o||(o=v({type:$(t.value)},o)),e.state={schema:o},e.path=tt(e.props.path,e.props.editKey),e}return y(r,n),r.prototype.componentWillReceiveProps=function(t){if(t.editKey===this.props.editKey&&t.path===this.props.path||(this.path=tt(t.path,t.editKey)),this.props.schema!==t.schema){var e=t.schema||{};"type"in e||(e=v({type:$(t.value)},e)),this.setState(function(){return{schema:e}})}},r.prototype.render=function(){return e(t,v({},this.props,{path:this.path,schema:this.state.schema}))},r}(n)}function nt(t){var e=t.value,n=t.schema.value;return void 0!==e?e:n}function rt(t){return function(n){function r(t){l(this,r);var e=d(this,n.call(this,t));return e.state={val:nt(t)},e.notifyDefaultChange(),e}return y(r,n),r.prototype.componentDidMount=function(){},r.prototype.componentWillReceiveProps=function(t){void 0===t.status.state?this.setState({val:nt(t)}):this.setState({val:t.value})},r.prototype.componentDidUpdate=function(){this.notifyDefaultChange()},r.prototype.notifyDefaultChange=function(){this.props.value!==this.state.val&&this.props.dispatch(D,this.props.path,this.state.val)},r.prototype.render=function(){return e(t,v({},this.props,{value:this.state.val}))},r}(n)}var ot=function(t){function n(e){l(this,n);var r=d(this,t.call(this,e));return r.onChange=function(){for(var t=arguments.length,n=Array(t),o=0;o<t;o++)n[o]=arguments[o];e.dispatch.apply(e,[E,r.props.path].concat(n))},r}return y(n,t),n.prototype.render=function(){var t=this.props.schema.type,n=Array.isArray(t)?t.find(function(t){return"null"!==t}):t,r=void 0;return void 0===(r=void 0===n||"null"===n?Z:X[n])&&(r=Z),e(r,v({},this.props,{onChange:this.onChange}))},n}(n);ot.defaultProps={path:[]};var at=et(rt(Y(ot))),it=i({schema:"schema",status:"status",value:"value"},at);function ut(){}var st=function(t){function n(e){l(this,n);var r=d(this,t.call(this,e));return r.event=!1,r.tree=u(),r.updateTree(e.value,e.schema),r.rooted=a(r.tree,it),r}return y(n,t),n.prototype.componentDidMount=function(){var t=this;this.tree.select("value").on("update",function(e){t.event&&t.props.onChange(e.data.currentData,C(e.data.currentData,t.tree.get("schema"),e.data.currentData).errors)})},n.prototype.componentWillReceiveProps=function(t){t.value===this.tree.get("value")&&t.schema===this.props.schema||this.updateTree(t.value,t.schema)},n.prototype.componentWillUnmount=function(){this.tree.release()},n.prototype.shouldComponentUpdate=function(){return!1},n.prototype.getValue=function(){return this.tree.get("value")},n.prototype.updateTree=function(t,e){this.event=!1,this.tree.set("value",t),this.tree.set("schema",e),this.tree.set("status",{}),this.tree.commit(),this.event=!0},n.prototype.validate=function(){var t=C(this.tree.get("value"),this.tree.get("schema"),this.tree.get("value"));return P(this.tree,[],t.errors),t.errors},n.prototype.render=function(){var t=this.rooted;return e(t,{onChange:ut,path:[]})},n}(n);st.defaultProps={schema:{}};export default st;export{p as setDefaultWidgets};
//# sourceMappingURL=index.es2015.js.map
