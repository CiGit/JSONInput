import{createElement as t,Component as e,createContext as r}from"react";import n from"immer";import{Validator as o,SchemaError as a}from"jsonschema";import{set as i,get as u,unset as s,setWith as c,cloneDeep as p}from"lodash-es";var h="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},l=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},f=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}return t},v=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},d=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},y=r({value:void 0,schema:{},status:{}}),m=y.Consumer,g=function(e){function r(){l(this,r);var t=d(this,e.apply(this,arguments));return t.state={schema:{},value:{},extValue:{},status:{},oldProps:{}},t.dispatch=function(e){for(var r=arguments.length,o=Array(r>1?r-1:0),a=1;a<r;a++)o[a-1]=arguments[a];t.setState(function(t){return n(e).apply(void 0,[t].concat(o))})},t}return v(r,e),r.getDerivedStateFromProps=function(t,e){if(e.oldProps!==t){var r={value:t.value,schema:t.schema,oldProps:t};return t.value!==e.extValue&&(r.status={},r.extValue=t.value),r}return null},r.prototype.shouldComponentUpdate=function(t,e){return this.state!==e},r.prototype.componentDidUpdate=function(t,e){var r=this;if(this.state.value!==e.value&&this.props.value===t.value){var n=this.state.value;this.setState({extValue:n},function(){return r.props.onValueChange(n)})}},r.prototype.render=function(){var e=this.state,r=e.schema,n=e.value,o=e.status;return t(y.Provider,{value:this.state},this.props.children({schema:r,value:n,status:o,dispatch:this.dispatch}))},r}(e);function b(e){return function(){return t("span",null,"Widget for '"+e+"' was not defined")}}var C={};function w(t){return C[t]||b(t)}function j(t){C=Object.assign({},C,t)}var P={};function K(e){var r=e.value,n=e.schema,o=e.schema.view,a={value:r,schema:n,children:e.children,editKey:e.editKey,path:e.path,onChange:e.onChange,onChildAdd:e.onChildAdd,onChildRemove:e.onChildRemove,addKey:e.addKey,removeKey:e.removeKey,alterKey:e.alterKey,errorMessage:e.errorMessage};if(o){var i=o.type;if("string"==typeof i){var u=w(i);return t(u,f({},a,{view:o}))}if("function"==typeof i)return t(i,f({},a,{view:o}))}var s=Array.isArray(n.type)?n.type.find(function(t){return"null"!==t}):n.type,c=void 0;return c=w(void 0===s?"undefinedType":s),t(c,f({},a,{view:o||P}))}var O=new o;function S(t,e,r){return O.validate(t,e,{formValue:r||{}})}O.attributes.errored=function(t,e,r){if("function"!=typeof e.errored)throw new a('"errored" expects a function');var n=e.errored(t,r.formValue);if(n)return n};var A="value",E="status",_="$$$state",x="$$$errors",V=[];function k(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments[2],n=[E].concat(e).concat([x]);c(t,n,r,Object)}function N(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments[2],n=new Map;r.forEach(function(t){var e=n.get(t.property)||[];e.push(t.message),n.set(t.property,e)}),k(t,e,V),n.forEach(function(r,n){k(t,e.concat(n.split(/\.|\[|\]/).filter(function(t){return""!==t}).slice(1)),r)})}function $(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments[2],n=arguments[3],o=[E].concat(e);i(t,[A].concat(e),r),c(t,o.concat([_]),"dirty",Object),N(t,e,n)}function D(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];$(t,e,arguments[2],[]),c(t,[E].concat(e).concat([_]),"pristine",Object)}function R(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];try{s(t,[E].concat(e))}catch(t){}}function U(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return u(t,[E].concat(e).concat([x]))||V}function F(r){var n=function(e){function n(){l(this,n);var t=d(this,e.apply(this,arguments));return t.onChange=function(e){var r=S(e,t.props.schema,t.props.__tree.value);t.props.onChange(e,r.errors)},t}return v(n,e),n.prototype.shouldComponentUpdate=function(t){return this.props.value!==t.value||this.props.schema!==t.schema||U(this.props.__tree,this.props.path)!==U(t.__tree,t.path)},n.prototype.render=function(){var e=this.props.path;return t(r,f({},this.props,{errorMessage:U(this.props.__tree,e),onChange:this.onChange}))},n}(e);return function(e){return t(m,null,function(r){return t(n,f({},e,{__tree:r}))})}}function M(t,e){var r=t.properties,n=void 0===r?{}:r;if(e in n)return n[e]}function T(t,e){var r=t.patternProperties||{},n=Object.keys(r).find(function(t){return new RegExp(t).test(e)});if(n)return r[n]}function W(t,e){return M(t,e)||T(t,e)||t.additionalProperties}var q={};function z(e){var r=[],n=e.schema.properties||{},o=e.value||{},a=Object.keys(n);function i(t){if(n[t]){var e=n[t].index;if("number"==typeof e)return e}return 0}Object.keys(o).forEach(function(t){t in n||a.push(t)}),a.sort(function(t,e){return i(t)-i(e)});for(var u=0;u<a.length;u+=1){var s=a[u],c=W(e.schema,s);r.push(t(vt,f({},e,{status:e.status[s]||q,schema:c,value:o[s],editKey:s,key:u})))}return r}function B(e){return t(K,f({},e,{addKey:function(t,r){var n;if("object"===h(e.value)&&t in e.value)throw new Error('Property "'+t+'" already exists');e.onChange(Object.assign({},e.value,((n={})[t]=r,n)))},removeKey:function(t){var r=Object.assign({},e.value);delete r[t],e.onChange(r)},alterKey:function(t,r){if(t!==r){if(r in e.value)throw new Error('Property "'+r+'" already exists');var n={};Object.keys(e.value).forEach(function(o){o!==t?n[o]=e.value[o]:n[r]=e.value[o]}),e.onChange(n)}}}),z(e))}var G=F(B);function H(e){return t(K,e)}var I=F(H);function J(t){switch(void 0===t?"undefined":h(t)){case"number":return t;case"string":return""===t?void 0:Number(t);default:return}}var L=function(e){function r(){l(this,r);var t=d(this,e.apply(this,arguments));return t.state={value:t.props.value},t.onChange=function(e){var r=""===e?void 0:e,n=Number(r);t.setState({value:r},function(){return t.props.onChange(isNaN(n)?r:n)})},t}return v(r,e),r.prototype.render=function(){return t(H,f({},this.props,{value:this.state.value,onChange:this.onChange}))},r}(e);L.getDerivedStateFromProps=function(t,e){return J(e.value)!==J(t.value)?{value:t.value}:null};var Q=F(L);function X(e){return t(K,e)}var Y=F(X),Z={};function tt(t){return function(e){var r=t.value||[];t.onChange(r.filter(function(t,r){return Number(r)!==Number(e)}))}}function et(t){return function(e){var r=t.value||[];t.onChange(r.concat([e]))}}function rt(e){var r=e.value,n=e.schema.items,o=[];return(r||[]).forEach(function(r,a){return o.push(t(vt,f({},e,{schema:Array.isArray(n)?n[a]||{}:n,value:r,editKey:String(a),status:e.status[String(a)]||Z,key:a})))}),o}function nt(e){return t(K,f({},e,{onChildAdd:et(e),onChildRemove:tt(e)}),rt(e))}var ot=F(nt),at={object:G,string:I,number:Q,boolean:Y,array:ot};function it(e){return function(r){var n=r.schema.visible,o=r.value;return t(m,null,function(a){var i=a.value;try{if(n&&!n(o,i,r.path.concat()))return null}catch(t){return null}return t(e,r)})}}function ut(e){return t("div",null,'Undefined field type "'+e.schema.type.toString()+'", ['+e.path.toString()+"]")}function st(t){switch(void 0===t?"undefined":h(t)){case"number":return"number";case"string":return"string";case"boolean":return"boolean";case"object":return Array.isArray(t)?"array":"object";default:return"string"}}function ct(t,e){return void 0!==e?t.concat([e]):t}function pt(r){return function(e){function n(){l(this,n);var t=d(this,e.apply(this,arguments));return t.state={path:[],schema:{},oldPath:null,oldEditKey:null},t}return v(n,e),n.getDerivedStateFromProps=function(t,e){var r={};if(e.oldEditKey===t.editKey&&e.oldPath===t.path||(r.path=ct(t.path,t.editKey),r.oldPath=t.path,r.oldEditKey=t.editKey),e.schema!==t.schema||st(t.value)!==st(e.oldValue)){var n=t.schema||{};"type"in n||(n=f({type:st(t.value)},n)),r.schema=n}return r},n.prototype.render=function(){var e=this.state.schema.type;return t(r,f({key:Array.isArray(e)?void 0:e},this.props,{path:this.state.path,schema:this.state.schema}))},n}(e)}function ht(t){var e=t.value,r=t.schema.value,n=t.dispatch,o=t.path,a=void 0!==e?e:p(r);return a!==e&&n(D,o,a),a}function lt(r){return function(e){function n(){l(this,n);var t=d(this,e.apply(this,arguments));return t.state={val:ht(t.props),init:!0},t}return v(n,e),n.getDerivedStateFromProps=function(t,e){return e.init?{init:!1}:{val:t.value}},n.prototype.render=function(){return t(r,f({},this.props,{value:this.state.val}))},n}(e)}var ft=function(e){function r(t){l(this,r);var n=d(this,e.call(this,t));return n.onChange=n.onChange.bind(n),n}return v(r,e),r.prototype.onChange=function(){for(var t,e=arguments.length,r=Array(e),n=0;n<e;n++)r[n]=arguments[n];(t=this.props).dispatch.apply(t,[$,this.props.path].concat(r))},r.prototype.componentWillUnmount=function(){this.props.dispatch(R,this.props.path)},r.prototype.render=function(){var e=this.props.schema.type,r=Array.isArray(e)?e.find(function(t){return"null"!==t}):e,n=void 0;return void 0===(n=void 0===r||"null"===r?ut:at[r])&&(n=ut),t(n,f({},this.props,{onChange:this.onChange}))},r}(e);ft.defaultProps={path:[]};var vt=pt(lt(it(ft))),dt=[],yt=function(e){function r(){l(this,r);var t=d(this,e.apply(this,arguments));return t.store=null,t.update=function(e){t.props.onChange(e,S(e,t.props.schema,e).errors)},t}return v(r,e),r.prototype.getValue=function(){return this.store.state.value},r.prototype.validate=function(){var t=S(this.store.state.value,this.store.state.schema,this.store.state.value);return this.store.dispatch(N,[],t.errors),t.errors},r.prototype.render=function(){var e=this;return t(g,{ref:function(t){e.store=t},value:this.props.value,schema:this.props.schema,onValueChange:this.update},function(e){var r=e.schema,n=e.value,o=e.status,a=e.dispatch;return t(vt,{schema:r,dispatch:a,value:n,path:dt,status:o})})},r}(e);yt.defaultProps={schema:{}};export default yt;export{j as setDefaultWidgets};
//# sourceMappingURL=index.es2015.js.map
