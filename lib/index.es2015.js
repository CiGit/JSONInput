import{createElement as t,Component as e,createContext as r}from"react";import n from"immer";import{Validator as o,SchemaError as a}from"jsonschema";import{set as u,get as i,unset as s,cloneDeep as c}from"lodash-es";var p="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},l=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},h=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(t[n]=r[n])}return t},f=function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},v=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e},d=r({value:void 0,schema:{},status:{}}),y=d.Consumer,m=function(e){function r(){l(this,r);var t=v(this,e.apply(this,arguments));return t.state={schema:{},value:{},status:{},oldProps:{}},t.dispatch=function(e){for(var r=arguments.length,o=Array(r>1?r-1:0),a=1;a<r;a++)o[a-1]=arguments[a];t.setState(function(t){return n(e).apply(void 0,[t].concat(o))})},t}return f(r,e),r.getDerivedStateFromProps=function(t,e){if(e.oldProps!==t){var r={value:t.value,schema:t.schema,oldProps:t};return t.value!==e.value&&(r.status={}),r}return null},r.prototype.shouldComponentUpdate=function(t,e){return this.state!==e},r.prototype.componentDidUpdate=function(t,e){this.state.value!==e.value&&this.props.value===t.value&&this.props.onValueChange(this.state.value)},r.prototype.render=function(){var e=this.state,r=e.schema,n=e.value,o=e.status;return t(d.Provider,{value:this.state},this.props.children({schema:r,value:n,status:o,dispatch:this.dispatch}))},r}(e);function g(e){return function(){return t("span",null,"Widget for '"+e+"' was not defined")}}var b={};function C(t){return b[t]||g(t)}function w(t){b=Object.assign({},b,t)}var P={};function K(e){var r=e.value,n=e.schema,o=e.schema.view,a={value:r,schema:n,children:e.children,editKey:e.editKey,path:e.path,onChange:e.onChange,onChildAdd:e.onChildAdd,onChildRemove:e.onChildRemove,addKey:e.addKey,removeKey:e.removeKey,alterKey:e.alterKey,errorMessage:e.errorMessage};if(o){var u=o.type;if("string"==typeof u){var i=C(u);return t(i,h({},a,{view:o}))}if("function"==typeof u)return t(u,h({},a,{view:o}))}var s=Array.isArray(n.type)?n.type.find(function(t){return"null"!==t}):n.type,c=void 0;return c=C(void 0===s?"undefinedType":s),t(c,h({},a,{view:o||P}))}var j=new o;function S(t,e,r){return j.validate(t,e,{formValue:r||{}})}j.attributes.errored=function(t,e,r){if("function"!=typeof e.errored)throw new a('"errored" expects a function');var n=e.errored(t,r.formValue);if(n)return n};var O="value",E="status",A="$$$state",$="$$$errors",x=[];function k(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments[2],n=[E].concat(e).concat([$]);u(t,n,r)}function N(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments[2],n=new Map;r.forEach(function(t){var e=n.get(t.property)||[];e.push(t.message),n.set(t.property,e)}),k(t,e,x),n.forEach(function(r,n){k(t,e.concat(n.split(/\.|\[|\]/).filter(function(t){return""!==t}).slice(1)),r)})}function V(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],r=arguments[2],n=arguments[3],o=[E].concat(e);u(t,[O].concat(e),r),u(t,o.concat([A]),"dirty"),N(t,e,n)}function D(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];V(t,e,arguments[2],[]),u(t,[E].concat(e).concat([A]),"pristine")}function R(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];try{s(t,[E].concat(e))}catch(t){}}function F(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[];return i(t,[E].concat(e).concat([$]))||x}function M(e){return function(r){return t(y,null,function(n){return t(e,h({},r,{errorMessage:F(n,r.path),onChange:function(t){var e=S(t,r.schema,n.value);r.onChange(t,e.errors)}}))})}}function U(t,e){var r=t.properties,n=void 0===r?{}:r;if(e in n)return n[e]}function _(t,e){var r=t.patternProperties||{},n=Object.keys(r).find(function(t){return new RegExp(t).test(e)});if(n)return r[n]}function T(t,e){return U(t,e)||_(t,e)||t.additionalProperties}var W={};function q(e){var r=[],n=e.schema.properties||{},o=e.value||{},a=Object.keys(n);function u(t){if(n[t]){var e=n[t].index;if("number"==typeof e)return e}return 0}Object.keys(o).forEach(function(t){t in n||a.push(t)}),a.sort(function(t,e){return u(t)-u(e)});for(var i=0;i<a.length;i+=1){var s=a[i],c=T(e.schema,s);r.push(t(ft,h({},e,{status:e.status[s]||W,schema:c,value:o[s],editKey:s,key:i})))}return r}function z(e){return t(K,h({},e,{addKey:function(t,r){var n;if("object"===p(e.value)&&t in e.value)throw new Error('Property "'+t+'" already exists');e.onChange(Object.assign({},e.value,((n={})[t]=r,n)))},removeKey:function(t){var r=Object.assign({},e.value);delete r[t],e.onChange(r)},alterKey:function(t,r){if(t!==r){if(r in e.value)throw new Error('Property "'+r+'" already exists');var n={};Object.keys(e.value).forEach(function(o){o!==t?n[o]=e.value[o]:n[r]=e.value[o]}),e.onChange(n)}}}),q(e))}var B=M(z);function G(e){return t(K,e)}var H=M(G);function I(t){switch(void 0===t?"undefined":p(t)){case"number":return t;case"string":return""===t?void 0:Number(t);default:return}}var J=function(e){function r(){l(this,r);var t=v(this,e.apply(this,arguments));return t.state={value:t.props.value},t.onChange=function(e){var r=""===e?void 0:e,n=Number(r);t.setState({value:r},function(){return t.props.onChange(isNaN(n)?r:n)})},t}return f(r,e),r.prototype.render=function(){return t(G,h({},this.props,{value:this.state.value,onChange:this.onChange}))},r}(e);J.getDerivedStateFromProps=function(t,e){return I(e.value)!==I(t.value)?{value:t.value}:null};var L=M(J);function Q(e){return t(K,e)}var X=M(Q),Y={};function Z(t){return function(e){var r=t.value||[];t.onChange(r.filter(function(t,r){return Number(r)!==Number(e)}))}}function tt(t){return function(e){var r=t.value||[];t.onChange(r.concat([e]))}}function et(e){var r=e.value,n=e.schema.items,o=[];return(r||[]).forEach(function(r,a){return o.push(t(ft,h({},e,{schema:Array.isArray(n)?n[a]||{}:n,value:r,editKey:String(a),status:e.status[String(a)]||Y,key:a})))}),o}function rt(e){return t(K,h({},e,{onChildAdd:tt(e),onChildRemove:Z(e)}),et(e))}var nt=M(rt),ot={object:B,string:H,number:L,boolean:X,array:nt};function at(e){return function(r){var n=r.schema.visible,o=r.value;return t(y,null,function(a){var u=a.value;try{if(n&&!n(o,u,r.path.concat()))return null}catch(t){return null}return t(e,r)})}}function ut(e){return t("div",null,'Undefined field type "'+e.schema.type.toString()+'", ['+e.path.toString()+"]")}function it(t){switch(void 0===t?"undefined":p(t)){case"number":return"number";case"string":return"string";case"boolean":return"boolean";case"object":return Array.isArray(t)?"array":"object";default:return"string"}}function st(t,e){return void 0!==e?t.concat([e]):t}function ct(r){return function(e){function n(){l(this,n);var t=v(this,e.apply(this,arguments));return t.state={path:[],schema:{},oldPath:null,oldEditKey:null},t}return f(n,e),n.getDerivedStateFromProps=function(t,e){var r={};if(e.oldEditKey===t.editKey&&e.oldPath===t.path||(r.path=st(t.path,t.editKey),r.oldPath=t.path,r.oldEditKey=t.editKey),e.schema!==t.schema||it(t.value)!==it(e.oldValue)){var n=t.schema||{};"type"in n||(n=h({type:it(t.value)},n)),r.schema=n}return r},n.prototype.render=function(){return t(r,h({},this.props,{path:this.state.path,schema:this.state.schema}))},n}(e)}function pt(t){var e=t.value,r=t.schema.value,n=t.dispatch,o=t.path,a=void 0!==e?e:c(r);return a!==e&&n(D,o,a),a}function lt(r){return function(e){function n(){l(this,n);var t=v(this,e.apply(this,arguments));return t.state={val:void 0},t}return f(n,e),n.getDerivedStateFromProps=function(t){return void 0===t.status.$$$state?{val:pt(t)}:{val:t.value}},n.prototype.render=function(){return t(r,h({},this.props,{value:this.state.val}))},n}(e)}var ht=function(e){function r(t){l(this,r);var n=v(this,e.call(this,t));return n.onChange=n.onChange.bind(n),n}return f(r,e),r.prototype.onChange=function(){for(var t,e=arguments.length,r=Array(e),n=0;n<e;n++)r[n]=arguments[n];(t=this.props).dispatch.apply(t,[V,this.props.path].concat(r))},r.prototype.componentWillUnmount=function(){this.props.dispatch(R,this.props.path)},r.prototype.render=function(){var e=this.props.schema.type,r=Array.isArray(e)?e.find(function(t){return"null"!==t}):e,n=void 0;return void 0===(n=void 0===r||"null"===r?ut:ot[r])&&(n=ut),t(n,h({},this.props,{onChange:this.onChange}))},r}(e);ht.defaultProps={path:[]};var ft=ct(lt(at(ht))),vt=[],dt=function(e){function r(){l(this,r);var t=v(this,e.apply(this,arguments));return t.store=null,t}return f(r,e),r.prototype.getValue=function(){return this.store.state.value},r.prototype.validate=function(){var t=S(this.store.state.value,this.store.state.schema,this.store.state.value);return this.store.dispatch(N,[],t.errors),t.errors},r.prototype.render=function(){var e=this;return t(m,{ref:function(t){e.store=t},value:this.props.value,schema:this.props.schema,onValueChange:function(t){return e.props.onChange(t,S(t,e.props.schema,t).errors)}},function(e){var r=e.schema,n=e.value,o=e.status,a=e.dispatch;return t(ft,{schema:r,dispatch:a,value:n,path:vt,status:o})})},r}(e);dt.defaultProps={schema:{}};export default dt;export{w as setDefaultWidgets};
//# sourceMappingURL=index.es2015.js.map
